---
title: "Structural Divergence Analysis"
author: "Maria Laura Marcos, Julian Echave"
output: html_document
---

# Introduction
We study the evolutionary divergence of proteins using the LF-ENM and comparing simulated mutants with experimental data.

```{r setup, include = FALSE}
# set chunk options
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r load_packages}
# load packages
library(ggplot2)
library(reshape2)
library(plyr)
library(quantreg)
library(bio3d)

# load functions
source(file.path(data.dir, "multiplot.R"))
source(file.path(data.dir, "my-functions.R")) 
```

```{r set_my_colors}
# set my colors
myColors = c("blue", "darkgreen", "red", "red") 
names(myColors) <- c("exp", "mut", "strong", "mut+sel")
```

```{r set_run_variables}
# set significance factors
f95 = 1.96
f99 = 2.6
f999 = 3.3
```

```{r set_file_names}
# set input filenames
## data
reference.fname = file.path(data.dir, paste(family, "_ref.txt", sep = ""))
protein_list.fname = file.path(data.dir, paste(family, "_list.txt", sep = ""))
site.info.fname = file.path(data.dir, paste(p.ref, "_m.da.ca.csv", sep = ""))
min.da.CM.CA.fname = file.path(data.dir, paste(p.ref, "_min.da.CM.ca.csv", sep = ""))

## profiles to compare
local.score.exp.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.exp.local.score.csv", sep = ""))
local.score.strong.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_strong.sel_K.analysis_Keff_out_m.theo.local.score.csv", sep = ""))
local.score.mut.fname = file.path(data.dir,paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.theo.local.score.csv", sep = ""))
```

```{r set_reference_protein}
# which is the reference protein?
reference = as.character(read.table(reference.fname, header = F)[1, 1])
if (reference != p.ref) {
  print("Warning: different references")
}
```

We studied the `r family` family. 
We used the ENM `r enm` with R0 = `r R0` to generate mutants.
We used as reference for the ENM the protein with pdb code `r reference`. 
We simulated `r n.mut.p` mutants of this reference for each protein of the family.
The `r family` family is of the type `r type` and consists of the following proteins:

```{r set_experimental_protein_names, comment = ""}
# experimental protein names
protein.exp = read.table(protein_list.fname, header = F, stringsAsFactors = F)[, 1]
protein.exp = protein.exp[protein.exp != reference]
print(protein.exp)
```

```{r set_site_info}
# read site information of the reference protein
site.info = read.csv(site.info.fname, header = T, sep = ",")
m.min.da.CM.CA = read.csv(min.da.CM.CA.fname)

# add info to site.info
d = ddply(site.info, "site", .fun = function(x) data.frame("da" = min(x[, c(-1, -2)])))

# define shells of active site neighborhood
d$shell = cut(d$da, breaks = c(-.1, 2.5, 7.5, 12.5, 17.5, 22.5, 27.5, 32.5, 37.5, 42.5, 47.5, 52.5, max(d$da)))
levels(d$shell) = seq(length(levels(d$shell))) - 1 # rename shell levels
site.info = merge(site.info, d, by = "site")

# read reference pdb and calculate resno, AA, and CN
reference.pdb.fname = file.path(data.dir,paste(reference, ".pdb", sep = ""))
ref.pdb = read.pdb(reference.pdb.fname)
inds = atom.select(ref.pdb, elety = "CA")
ref.pdb.ca = ref.pdb$atom[inds$atom,]
cmap.ca = cmap(ref.pdb$xyz[inds$xyz], dcut = R0, scut = 0, mask.lower = F)
CN = rowSums(cmap.ca, na.rm = T) - 1 # diag(cmap.ca) returned by cmap is 1!
AA = ref.pdb.ca$resid
resno = ref.pdb.ca$resno
pdb.info = data.frame(resno, AA, CN)
names(pdb.info) = c("resno", "AA", paste("CN", as.character(R0), sep = ""))

# add pdb.info to site.info
site.info = cbind(site.info, pdb.info)
```

```{r read_data}
# read data
## exp
local.score.exp = read.csv(local.score.exp.fname, header = T)
site = site.info$site
local.score.exp = local.score.exp[1:length(protein.exp), site]
rownames(local.score.exp) = protein.exp

## mut
local.score.mut = read.csv(local.score.mut.fname, header = T)
site = site.info$site
local.score.mut = local.score.mut[1:length(protein.exp), site]
rownames(local.score.mut) = paste("mut", rownames(local.score.mut), sep = "")

## strong
local.score.strong = read.csv(local.score.strong.fname, header = T)
site = site.info$site
local.score.strong = local.score.strong[1:length(protein.exp), site]
rownames(local.score.strong) = paste("strong", rownames(local.score.strong), sep = "")
```

# Structural divergence along sites

Here we study how structural divergence varies from site to site. We compare simulated data with empirical data. 

```{r prepare_site_data}
# prepare the data
## exp
tlocal.score.exp = as.data.frame(t(as.matrix(local.score.exp)))
tlocal.score.exp = cbind(site.info, tlocal.score.exp)
siteComparison.exp = melt(tlocal.score.exp, id.vars = names(site.info), variable.name = "protein", value.name = "local.score")

## mut
tlocal.score.mut = as.data.frame(t(as.matrix(local.score.mut)))
tlocal.score.mut = cbind(site.info, tlocal.score.mut)
siteComparison.mut = melt(tlocal.score.mut, id.vars = names(site.info), variable.name = "protein", value.name = "local.score")

## strong
tlocal.score.strong = as.data.frame(t(as.matrix(local.score.strong)))
tlocal.score.strong = cbind(site.info, tlocal.score.strong)
siteComparison.strong = melt(tlocal.score.strong, id.vars = names(site.info), variable.name = "protein", value.name = "local.score")

# bluild the data.frame
siteComparison.all.datasets = rbind(data.frame("dataset" = "exp", siteComparison.exp),
                                    data.frame("dataset" = "mut", siteComparison.mut),
                                    data.frame("dataset" = "strong", siteComparison.strong))

siteComparison.all.datasets = ddply(siteComparison.all.datasets, c("dataset", "protein"), mutate,
          "local.score" = (local.score), 
          "n.local.score" = local.score/mean(local.score, na.rm = T),
          "z.local.score" = vscale(local.score))
```

### Mean z.local.score vs site

To measure structural divergence we use z.local.score profiles, which are the best for most families.

The following plot compares the mean z.local.score profiles, including standard errors (with .999 confidence level for the mean)
*Warning: the effective number of data should be smaller than the actual data, especially for the experimental dataset because of several factors. We need to deal with this for quantitative analysis. Probably we'll need to use bootstrapping to calculate standard errors non-parametrically*

```{r mean_se_z.local.score_vs_site, fig.cap = "Black lines are the active sites and grey lines are their contacts"}
# comparison of z.local.score profiles with functional sites
## prepare dat
dat = siteComparison.all.datasets
dat$dataset = revalue(dat$dataset, c("strong" = "mut+sel"))

## dat with means and standard errors
d = ddply(dat,c("dataset", "site", "AA", "shell"), function(x) {
                mean.z.local.score = mean(x$z.local.score, na.rm = T)
                ndata = sum(!is.na(x$z.local.score))
                se.z.local.score = sd(x$z.local.score, na.rm = T) / sqrt(ndata)
                data.frame(mean.z.local.score, ndata, se.z.local.score)
})

## find the active site and its contacts
active.sites = d$site[d$shell == 0]
contacts.active.sites = d$site[d$shell == 1]

## prepare plots with mean profiles and deviations
p = ggplot(d, aes(x = site, y = mean.z.local.score, col = dataset, fill = dataset)) +
    geom_line() +
    geom_ribbon(aes(ymin = mean.z.local.score - f95 * se.z.local.score, ymax = mean.z.local.score + se.z.local.score), alpha = .4, show.legend = F) +
    geom_vline(xintercept = active.sites, show.legend = F) +
    geom_vline(xintercept = contacts.active.sites, col = "grey", show.legend = F) +
    labs(x = "site", y = "structural divergence(mean z.local.score)") +
    coord_cartesian(ylim = c(-1.5, 2.8)) +
    scale_colour_manual(name = NULL, values = myColors) + 
    scale_fill_manual(name = NULL, values = myColors)

## plot separate and comparative plots
p.facet = p + facet_grid(dataset~., switch = "y") + theme(legend.position = "bottom")

p.facet %+% subset(d, dataset == "exp") 
p.facet %+% subset(d, dataset == "mut")
p.facet %+% subset(d, dataset == "mut+sel") 
p.facet

## plot superimposed plots
p + theme(legend.position = "bottom")
```

### Correlation between site profiles

```{r_comparison_mean_z.local.score_vs_site, fig.cap = "Black lines are the active sites and grey lines are their contacts"}
# comparison of z.local.score profiles
ggplot(d, aes(x = site, y = mean.z.local.score, col = dataset)) +
  geom_line() +
  geom_text(data = subset(d, dataset == "exp" & mean.z.local.score < -.5), aes(x = site, y = mean.z.local.score, label = site), nudge_y = -.1, size = 1.8)+
  geom_vline(xintercept = active.sites, show.legend = F) +
  geom_vline(xintercept = contacts.active.sites, col = "grey", show.legend = F) + 
  scale_colour_manual(name = NULL, values = myColors) 

# calculate correlations berween profiles
d.exp = subset(d, dataset == "exp")
d.mut = subset(d, dataset == "mut")
d.strong = subset(d, dataset == "mut+sel")

r.exp.mut = cor(d.exp$mean.z.local.score, d.mut$mean.z.local.score)
r.exp.strong = cor(d.exp$mean.z.local.score, d.strong$mean.z.local.score)
r.mut.strong = cor(d.mut$mean.z.local.score, d.strong$mean.z.local.score)

cor.df = data.frame("comparison" = c("exp vs mut", "exp vs strong", "mut vs strong"),
                    "R" = c(r.exp.mut, r.exp.strong, r.mut.strong))

knitr::kable(cor.df, digits = 2, caption = "Correlation between <Z-scores> profiles")
```

### Distances to the active sites

```{r_comparison_da}

# comparison of means.z.scores with the minimum distance to the functional sites
plot(y = d.exp$mean.z.local.score - d.mut$mean.z.local.score, x = m.min.da.CM.CA$min.da.ca, xlab = "minimal distance to active site (between CAs)", ylab = "exp.mean.z.local.score - mut.mean.z.local.score")
plot(y = d.exp$mean.z.local.score - d.mut$mean.z.local.score, x = m.min.da.CM.CA$min.da.CM, xlab = "minimal distance to active site (between CMs)", ylab = "exp.mean.z.local.score - mut.mean.z.local.score")

## calculate correlations between profiles
r.min.da.CA = cor((d.exp$mean.z.local.score - d.mut$mean.z.local.score), m.min.da.CM.CA$min.da.ca)
r.min.da.CM = cor((d.exp$mean.z.local.score - d.mut$mean.z.local.score), m.min.da.CM.CA$min.da.CM)

cor.df = data.frame("comparison" = c("(exp - mut) vs min.da.CA", "(exp - mut) vs min.da.CM"), "R" = c(r.min.da.CA, r.min.da.CM))

knitr::kable(cor.df, digits = 2, caption = "Correlation between differences in <Z-scores> profiles and the minimal distance to the active site")
```
