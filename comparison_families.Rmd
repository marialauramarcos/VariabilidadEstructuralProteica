---
title: "Structural and Dybamical Divergence Analysis -  Comparisons"
output: html_document
---

# Introduction
We study the evolutionary divergence of proteins using the mutational model LF-ENM and the selection model Stress Model. We compare simulated mutants with experimental data. 
In this report we compare the results obtained for diferrent families, using different R0s, and considering two different enm: CA (one node per site enm model: CA) and CM (two nodes per site enm model: CA and CM of side chains). 
R0 used were 7.5, 10 and 12.5 for CA and 5, 7.5 and 10 for CM.

```{r setup, include = FALSE}
# set chunk options
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r load-packages}
# load packages
library(ggplot2)
library(reshape2)
library(bio3d)
library(plyr)

# load functions
source(file.path(data.dir, "multiplot.R"))
source(file.path(data.dir, "my-functions.R"))
```
We analyzed the following families:

```{r input-families}
# read input
input.fname <- "input_MainReport.csv"
input <- read.csv(input.fname)
families <- input$family
print(as.character(families))
```
# Results

```{r calculate-correlations-CA}

# input
R0S = c(7.5, 10, 12.5)
data.dir = paste("OUT/out_subset_CA_ANM", sep = "")

number.R0 = length(R0S)
number.families = length(families)

cc.z.RSD.exp.mut = matrix(ncol = number.R0, nrow = number.families)
cc.z.RSD.exp.medium = matrix(ncol = number.R0, nrow = number.families)
cc.z.RSD.mut.medium = matrix(ncol = number.R0, nrow = number.families)

cc.Pn.exp.mut = matrix(ncol = number.R0, nrow = number.families)
cc.Pn.exp.medium = matrix(ncol = number.R0, nrow = number.families)
cc.Pn.mut.medium = matrix(ncol = number.R0, nrow = number.families)

cc.Pn.100.exp.mut = matrix(ncol = number.R0, nrow = number.families)
cc.Pn.100.exp.medium = matrix(ncol = number.R0, nrow = number.families)
cc.Pn.100.mut.medium = matrix(ncol = number.R0, nrow = number.families)

cc.MSF.exp.mut = matrix(ncol = number.R0, nrow = number.families)
cc.MSF.exp.medium = matrix(ncol = number.R0, nrow = number.families)
cc.MSF.mut.medium = matrix(ncol = number.R0, nrow = number.families)

cc.nH.exp.mut = matrix(ncol = number.R0, nrow = number.families)
cc.nH.exp.medium = matrix(ncol = number.R0, nrow = number.families)
cc.nH.mut.medium = matrix(ncol = number.R0, nrow = number.families)

cc.nH.100.exp.mut = matrix(ncol = number.R0, nrow = number.families)
cc.nH.100.exp.medium = matrix(ncol = number.R0, nrow = number.families)
cc.nH.100.mut.medium = matrix(ncol = number.R0, nrow = number.families)

# satart a loop for each family
for (f in (1:nrow(input))) { 
  family <- as.character(input$family)[f]
  type <- as.character(input$type)[f]
  p.ref <- as.character(input$p.ref)[f]
  enm <- as.character(input$enm)[f]
  n.mut.p <- input$n.mut.p[f]
  R0.CA = input$R0.CA[f]
  R0.CM = input$R0.CM[f]
  chain.p.ref <- as.character(input$chain.p.ref)[f]

  for (R0 in (R0S)) {

    ### z.RSD ###
    
    # set input filenames
    dri2.exp.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.exp.norm.dr.squarei.csv", sep = ""))
    dri2.medium.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_medium.sel_K.analysis_Keff_out_m.theo.norm.dr.squarei.csv", sep = ""))
    dri2.mut.fname = file.path(data.dir,paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.theo.norm.dr.squarei.csv", sep = ""))
    
    # read data
    dri2.exp = read.csv(dri2.exp.fname, header = T)
    dri2.mut = read.csv(dri2.mut.fname, header = T)
    dri2.medium = read.csv(dri2.medium.fname, header = T)
    n.sites = length(dri2.exp)
    
    # prepare data
    rownames(dri2.exp) = paste("mut", rownames(dri2.exp), sep = "")
    rownames(dri2.mut) = paste("mut", rownames(dri2.mut), sep = "")
    rownames(dri2.medium) = paste("mut", rownames(dri2.medium), sep = "")
    
    tdri2.exp = as.data.frame(t(as.matrix(dri2.exp)))
    tdri2.mut = as.data.frame(t(as.matrix(dri2.mut)))
    tdri2.medium = as.data.frame(t(as.matrix(dri2.medium)))
    
    site.info = seq(1:length(dri2.mut))
    
    tdri2.exp = cbind(site.info, tdri2.exp)
    tdri2.mut = cbind(site.info, tdri2.mut)
    tdri2.medium = cbind(site.info, tdri2.medium)
    
    siteComparison.exp = melt(tdri2.exp, id.vars = c("site.info"), variable.name = "protein", value.name = "dri2")
    siteComparison.mut = melt(tdri2.mut, id.vars = c("site.info"), variable.name = "protein", value.name = "dri2")
    siteComparison.medium = melt(tdri2.medium, id.vars = c("site.info"), variable.name = "protein", value.name = "dri2")
    
    # bluild the data.frame
    siteComparison.all.datasets = rbind(data.frame("dataset" = "exp", siteComparison.exp),
                                        data.frame("dataset" = "mut", siteComparison.mut),
                                        data.frame("dataset" = "medium", siteComparison.medium))
    
    siteComparison.all.datasets = ddply(siteComparison.all.datasets, c("dataset", "protein"), mutate,
                                        "n.SD" = dri2/mean(dri2, na.rm = T),
                                        "z.SD" = vscale(dri2),
                                        "RSD" = sqrt(dri2),
                                        "n.RSD" = RSD/mean(RSD, na.rm = T),
                                        "z.RSD" = vscale(RSD))
    
    dat = siteComparison.all.datasets
    dat$dataset = revalue(dat$dataset, c("medium" = "selection"))
    dat$dataset = revalue(dat$dataset, c("mut" = "no-selection"))
    
    ## dat with means and standard errors
    d = ddply(dat,c("dataset", "site.info"), function(x) {
        mean.z.RSD = mean(x$z.RSD, na.rm = T)
        ndata = sum(!is.na(x$z.RSD))
        se.z.RSD = sd(x$z.RSD, na.rm = T) / sqrt(ndata)
        data.frame(mean.z.RSD, ndata, se.z.RSD)
    })
    
    # calculate correlations berween profiles
    d.exp = subset(d, dataset == "exp")
    d.mut = subset(d, dataset == "no-selection")
    d.medium = subset(d, dataset == "selection")
    
    r.exp.mut = cor(d.exp$mean.z.RSD, d.mut$mean.z.RSD)
    r.exp.medium = cor(d.exp$mean.z.RSD, d.medium$mean.z.RSD)
    r.mut.medium = cor(d.mut$mean.z.RSD, d.medium$mean.z.RSD)
    
    cc.z.RSD.exp.mut[which(input$family == family), which(R0S == R0)] = r.exp.mut
    cc.z.RSD.exp.medium[which(input$family == family), which(R0S == R0)] = r.exp.medium
    cc.z.RSD.mut.medium[which(input$family == family), which(R0S == R0)] = r.mut.medium
    
    ### Pn ###
    
    # set input filenames
    Pn.exp.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.exp.Pn.csv", sep = ""))
    Pn.medium.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_medium.sel_K.analysis_Keff_out_m.theo.Pn.csv", sep = ""))
    Pn.mut.fname = file.path(data.dir,paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.theo.Pn.csv", sep = ""))
    
    # prepare the data
    Pn.exp = read.csv(Pn.exp.fname, header = T)
    rownames(Pn.exp) = paste("mut", rownames(Pn.exp), sep = "")
    Pn.mut = read.csv(Pn.mut.fname, header = T)
    rownames(Pn.mut) = paste("mut", rownames(Pn.mut), sep = "")
    Pn.medium = read.csv(Pn.medium.fname, header = T)
    rownames(Pn.medium) = paste("mut", rownames(Pn.medium), sep = "")
    
    mode = seq(ncol(Pn.medium))
    
    # Prepare modeComparison
    tPn.medium = as.data.frame(t(as.matrix(Pn.medium)))
    tPn.medium = cbind(data.frame("mode" = mode), tPn.medium)
    modeComparison.medium = melt(tPn.medium, "mode", variable.name = "protein", value.name = "Pn")
    modeComparison.medium = ddply(modeComparison.medium, "protein", mutate, "Pn" = Pn / mean(Pn, na.rm = T))
    
    tPn.mut = as.data.frame(t(as.matrix(Pn.mut)))
    tPn.mut = cbind(data.frame("mode" = mode), tPn.mut)
    modeComparison.mut = melt(tPn.mut, "mode", variable.name = "protein", value.name = "Pn")
    modeComparison.mut = ddply(modeComparison.mut, "protein", mutate, "Pn" = Pn / mean(Pn, na.rm = T))
    
    tPn.exp = as.data.frame(t(as.matrix(Pn.exp)))
    tPn.exp = cbind(data.frame("mode" = mode), tPn.exp)
    modeComparison.exp = melt(tPn.exp, "mode", variable.name = "protein", value.name = "Pn")
    modeComparison.exp = ddply(modeComparison.exp, "protein", mutate, "Pn" = Pn / mean(Pn, na.rm = T))
    
    # modeComparison.exp has NA's because for proteins with gaps when using Keff there're less modes
    #print("Warning: modeComparison.exp <- na.omit(modeComparison.exp)")
    modeComparison.exp <- na.omit(modeComparison.exp)
    modeComparison.medium <- na.omit(modeComparison.medium)
    modeComparison.mut <- na.omit(modeComparison.mut)
    
    modeComparison.all.datasets = rbind(data.frame("dataset" = "exp", modeComparison.exp),
                                        data.frame("dataset" = "mut", modeComparison.mut),
                                        data.frame("dataset" = "medium", modeComparison.medium))
    
    dat = modeComparison.all.datasets
    dat$dataset = revalue(dat$dataset, c("medium" = "selection"))
    dat$dataset = revalue(dat$dataset, c("mut" = "no-selection"))
    
    # calculate dataset of medians
    d = ddply(dat,c("dataset", "mode"), function(x) {
        median.Pn = median(x$Pn)
        data.frame(median.Pn)
    })
    
    # calculate correlations berween profiles
    d.exp = subset(d, dataset == "exp")
    d.mut = subset(d, dataset == "no-selection")
    d.medium = subset(d, dataset == "selection")
    
    r.exp.mut = cor(d.exp$median.Pn, d.mut$median.Pn)
    r.exp.medium = cor(d.exp$median.Pn, d.medium$median.Pn)
    r.mut.medium = cor(d.mut$median.Pn, d.medium$median.Pn)
    
    cc.Pn.exp.mut[which(input$family == family), which(R0S == R0)] = r.exp.mut
    cc.Pn.exp.medium[which(input$family == family), which(R0S == R0)] = r.exp.medium
    cc.Pn.mut.medium[which(input$family == family), which(R0S == R0)] = r.mut.medium
    
    # 100 modes
    r.exp.mut = cor(d.exp$median.Pn[1:100], d.mut$median.Pn[1:100])
    r.exp.medium = cor(d.exp$median.Pn[1:100], d.medium$median.Pn[1:100])
    r.mut.medium = cor(d.mut$median.Pn[1:100], d.medium$median.Pn[1:100])
    
    cc.Pn.100.exp.mut[which(input$family == family), which(R0S == R0)] = r.exp.mut
    cc.Pn.100.exp.medium[which(input$family == family), which(R0S == R0)] = r.exp.medium
    cc.Pn.100.mut.medium[which(input$family == family), which(R0S == R0)] = r.mut.medium
    
    ### MSF ###
    
    # set input filenames
    square.dif.MSF.exp.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.exp.square.dif.MSF.csv", sep = ""))
    square.dif.MSF.medium.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_medium.sel_K.analysis_Keff_out_m.theo.square.dif.MSF.csv", sep = ""))
    square.dif.MSF.mut.fname = file.path(data.dir,paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.theo.square.dif.MSF.csv", sep = ""))
    
    # prepare the data
    square.dif.MSF.exp = read.csv(square.dif.MSF.exp.fname, header = T)
    rownames(square.dif.MSF.exp) = paste("mut", rownames(square.dif.MSF.exp), sep = "")
    square.dif.MSF.mut = read.csv(square.dif.MSF.mut.fname, header = T)
    rownames(square.dif.MSF.mut) = paste("mut", rownames(square.dif.MSF.mut), sep = "")
    square.dif.MSF.medium = read.csv(square.dif.MSF.medium.fname, header = T)
    rownames(square.dif.MSF.medium) = paste("mut", rownames(square.dif.MSF.medium), sep = "")
    
    site = seq(ncol(square.dif.MSF.medium))
    
    # Prepare siteComparison
    tsquare.dif.MSF.medium = as.data.frame(t(as.matrix(square.dif.MSF.medium)))
    tsquare.dif.MSF.medium = cbind(data.frame("site" = site), tsquare.dif.MSF.medium)
    siteComparison.medium = melt(tsquare.dif.MSF.medium, "site", variable.name = "protein", value.name = "square.dif.MSF")
    
    tsquare.dif.MSF.mut = as.data.frame(t(as.matrix(square.dif.MSF.mut)))
    tsquare.dif.MSF.mut = cbind(data.frame("site" = site), tsquare.dif.MSF.mut)
    siteComparison.mut = melt(tsquare.dif.MSF.mut, "site", variable.name = "protein", value.name = "square.dif.MSF")
    
    tsquare.dif.MSF.exp = as.data.frame(t(as.matrix(square.dif.MSF.exp)))
    tsquare.dif.MSF.exp = cbind(data.frame("site" = site), tsquare.dif.MSF.exp)
    siteComparison.exp = melt(tsquare.dif.MSF.exp, "site", variable.name = "protein", value.name = "square.dif.MSF")
    
    siteComparison.all.datasets = rbind(data.frame("dataset" = "exp", siteComparison.exp),
                                        data.frame("dataset" = "mut", siteComparison.mut),
                                        data.frame("dataset" = "medium", siteComparison.medium))
    
    siteComparison.all.datasets = ddply(siteComparison.all.datasets, c("dataset", "protein"), mutate,
                                             "r.SDF" = rank(square.dif.MSF, na.last = "keep")) 
    
    dat = siteComparison.all.datasets
    dat$dataset = revalue(dat$dataset, c("medium" = "selection"))
    dat$dataset = revalue(dat$dataset, c("mut" = "no-selection"))
    
    # calculate dataset of means
    d = ddply(dat, c("dataset", "site"), function(x) {
        mean.r.SDF = mean(x$r.SDF, na.rm = T)
        data.frame(mean.r.SDF)
    })
    
    # calculate correlations berween profiles
    d.exp = subset(d, dataset == "exp")
    d.mut = subset(d, dataset == "no-selection")
    d.medium = subset(d, dataset == "selection")
    
    r.exp.mut = cor(d.exp$mean.r.SDF, d.mut$mean.r.SDF)
    r.exp.medium = cor(d.exp$mean.r.SDF, d.medium$mean.r.SDF)
    r.mut.medium = cor(d.mut$mean.r.SDF, d.medium$mean.r.SDF)
    
    cc.MSF.exp.mut[which(input$family == family), which(R0S == R0)] = r.exp.mut
    cc.MSF.exp.medium[which(input$family == family), which(R0S == R0)] = r.exp.medium
    cc.MSF.mut.medium[which(input$family == family), which(R0S == R0)] = r.mut.medium
    
    ### nH ###
    # set input filenames
    nH.exp.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.exp.nH.csv", sep = ""))
    nH.medium.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_medium.sel_K.analysis_Keff_out_m.theo.nH.csv", sep = ""))
    nH.mut.fname = file.path(data.dir,paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.theo.nH.csv", sep = ""))
    
    # prepare the data
    nH.exp = read.csv(nH.exp.fname, header = T)
    rownames(nH.exp) = paste("mut", rownames(nH.exp), sep = "")
    nH.mut = read.csv(nH.mut.fname, header = T)
    rownames(nH.mut) = paste("mut", rownames(nH.mut), sep = "")
    nH.medium = read.csv(nH.medium.fname, header = T)
    rownames(nH.medium) = paste("mut", rownames(nH.medium), sep = "")
    
    mode = seq(ncol(nH.medium))
    
    # Prepare modeComparison
    tnH.medium = as.data.frame(t(as.matrix(nH.medium)))
    tnH.medium = cbind(data.frame("mode" = mode), tnH.medium)
    modeComparison.medium = melt(tnH.medium, "mode", variable.name = "protein", value.name = "nH")
    modeComparison.medium = ddply(modeComparison.medium, "protein", mutate, "nH" = nH / mean(nH, na.rm = T))
    
    tnH.mut = as.data.frame(t(as.matrix(nH.mut)))
    tnH.mut = cbind(data.frame("mode" = mode), tnH.mut)
    modeComparison.mut = melt(tnH.mut, "mode", variable.name = "protein", value.name = "nH")
    modeComparison.mut = ddply(modeComparison.mut, "protein", mutate, "nH" = nH / mean(nH, na.rm = T))
    
    tnH.exp = as.data.frame(t(as.matrix(nH.exp)))
    tnH.exp = cbind(data.frame("mode" = mode), tnH.exp)
    modeComparison.exp = melt(tnH.exp, "mode", variable.name = "protein", value.name = "nH")
    modeComparison.exp = ddply(modeComparison.exp, "protein", mutate, "nH" = nH / mean(nH, na.rm = T))
    
    # modeComparison.exp has NA's because for proteins with gaps when using Keff there're less modes
    #print("Warning: modeComparison.exp <- na.omit(modeComparison.exp)")
    modeComparison.exp <- na.omit(modeComparison.exp)
    modeComparison.medium <- na.omit(modeComparison.medium)
    modeComparison.mut <- na.omit(modeComparison.mut)
    
    modeComparison.all.datasets = rbind(data.frame("dataset" = "exp", modeComparison.exp),
                                        data.frame("dataset" = "mut", modeComparison.mut),
                                        data.frame("dataset" = "medium", modeComparison.medium))
    
    dat = modeComparison.all.datasets
    dat$dataset = revalue(dat$dataset, c("medium" = "selection"))
    dat$dataset = revalue(dat$dataset, c("mut" = "no-selection"))
    
    # calculate dataset of means
    d = ddply(dat,c("dataset", "mode"), function(x) {
        mean.nH = mean(x$nH)
        data.frame(mean.nH)
    })
    
    # calculate correlations berween profiles
    d.exp = subset(d, dataset == "exp")
    d.mut = subset(d, dataset == "no-selection")
    d.medium = subset(d, dataset == "selection")
    
    r.exp.mut = cor(d.exp$mean.nH, d.mut$mean.nH)
    r.exp.medium = cor(d.exp$mean.nH, d.medium$mean.nH)
    r.mut.medium = cor(d.mut$mean.nH, d.medium$mean.nH)
    
    cc.nH.exp.mut[which(input$family == family), which(R0S == R0)] = r.exp.mut
    cc.nH.exp.medium[which(input$family == family), which(R0S == R0)] = r.exp.medium
    cc.nH.mut.medium[which(input$family == family), which(R0S == R0)] = r.mut.medium
    
    # 100 modes
    r.exp.mut = cor(d.exp$mean.nH[1:100], d.mut$mean.nH[1:100])
    r.exp.medium = cor(d.exp$mean.nH[1:100], d.medium$mean.nH[1:100])
    r.mut.medium = cor(d.mut$mean.nH[1:100], d.medium$mean.nH[1:100])
    
    cc.nH.100.exp.mut[which(input$family == family), which(R0S == R0)] = r.exp.mut
    cc.nH.100.exp.medium[which(input$family == family), which(R0S == R0)] = r.exp.medium
    cc.nH.100.mut.medium[which(input$family == family), which(R0S == R0)] = r.mut.medium
  }
}

cc.z.RSD = data.frame(cc.z.RSD.exp.mut, cc.z.RSD.exp.medium, cc.z.RSD.mut.medium)
cc.z.RSD = cc.z.RSD
cc.z.RSD = rbind(cc.z.RSD, colMeans(cc.z.RSD))
family = as.character(input$family)
cc.z.RSD_CA = data.frame(c(family, "mean"), cc.z.RSD)
colnames(cc.z.RSD_CA) = c("family", paste("exp-mut-R0.", seq(1:number.R0), sep = ""), paste("exp-sel-R0.", seq(1:number.R0), sep = ""), paste("mut-sel-R0.", seq(1:number.R0), sep = ""))

write.csv(cc.z.RSD_CA, file = "cc_z.RSD_CA.csv")

cc.Pn = data.frame(cc.Pn.exp.mut, cc.Pn.exp.medium, cc.Pn.mut.medium)
cc.Pn = cc.Pn
cc.Pn = rbind(cc.Pn, colMeans(cc.Pn))
family = as.character(input$family)
cc.Pn_CA = data.frame(c(family, "mean"), cc.Pn)
colnames(cc.Pn_CA) = c("family", paste("exp-mut-R0.", seq(1:number.R0), sep = ""), paste("exp-sel-R0.", seq(1:number.R0), sep = ""), paste("mut-sel-R0.", seq(1:number.R0), sep = ""))


write.csv(cc.Pn_CA, file = "cc_Pn_CA.csv")

cc.Pn.100 = data.frame(cc.Pn.100.exp.mut, cc.Pn.100.exp.medium, cc.Pn.100.mut.medium)
cc.Pn.100 = cc.Pn.100
cc.Pn.100 = rbind(cc.Pn.100, colMeans(cc.Pn.100))
family = as.character(input$family)
cc.Pn.100_CA = data.frame(c(family, "mean"), cc.Pn.100)
colnames(cc.Pn.100_CA) = c("family", paste("exp-mut-R0.", seq(1:number.R0), sep = ""), paste("exp-sel-R0.", seq(1:number.R0), sep = ""), paste("mut-sel-R0.", seq(1:number.R0), sep = ""))

write.csv(cc.Pn.100_CA, file = "cc_Pn_100_CA.csv")

cc.MSF = data.frame(cc.MSF.exp.mut, cc.MSF.exp.medium, cc.MSF.mut.medium)
cc.MSF = cc.MSF
cc.MSF = rbind(cc.MSF, colMeans(cc.MSF))
family = as.character(input$family)
cc.MSF_CA = data.frame(c(family, "mean"), cc.MSF)
colnames(cc.MSF_CA) = c("family", paste("exp-mut-R0.", seq(1:number.R0), sep = ""), paste("exp-sel-R0.", seq(1:number.R0), sep = ""), paste("mut-sel-R0.", seq(1:number.R0), sep = ""))

write.csv(cc.MSF_CA, file = "cc_MSF_CA.csv")

cc.nH = data.frame(cc.nH.exp.mut, cc.nH.exp.medium, cc.nH.mut.medium)
cc.nH = cc.nH
cc.nH = rbind(cc.nH, colMeans(cc.nH))
family = as.character(input$family)
cc.nH_CA = data.frame(c(family, "mean"), cc.nH)
colnames(cc.nH_CA) = c("family", paste("exp-mut-R0.", seq(1:number.R0), sep = ""), paste("exp-sel-R0.", seq(1:number.R0), sep = ""), paste("mut-sel-R0.", seq(1:number.R0), sep = ""))

write.csv(cc.nH_CA, file = "cc_nH_CA.csv")

cc.nH.100 = data.frame(cc.nH.100.exp.mut, cc.nH.100.exp.medium, cc.nH.100.mut.medium)
cc.nH.100 = cc.nH.100
cc.nH.100 = rbind(cc.nH.100, colMeans(cc.nH.100))
family = as.character(input$family)
cc.nH.100_CA = data.frame(c(family, "mean"), cc.nH.100)
colnames(cc.nH.100_CA) = c("family", paste("exp-mut-R0.", seq(1:number.R0), sep = ""), paste("exp-sel-R0.", seq(1:number.R0), sep = ""), paste("mut-sel-R0.", seq(1:number.R0), sep = ""))

write.csv(cc.nH.100_CA, file = "cc_nH_100_CA.csv")
```

```{r calculate-correlations-CM}

# input
R0S = c(5, 7.5, 10)
data.dir = paste("OUT/out_subset_CM_ANM", sep = "")

cc.z.RSD.exp.mut = matrix(ncol = number.R0, nrow = number.families)
cc.z.RSD.exp.medium = matrix(ncol = number.R0, nrow = number.families)
cc.z.RSD.mut.medium = matrix(ncol = number.R0, nrow = number.families)

cc.Pn.exp.mut = matrix(ncol = number.R0, nrow = number.families)
cc.Pn.exp.medium = matrix(ncol = number.R0, nrow = number.families)
cc.Pn.mut.medium = matrix(ncol = number.R0, nrow = number.families)

cc.Pn.100.exp.mut = matrix(ncol = number.R0, nrow = number.families)
cc.Pn.100.exp.medium = matrix(ncol = number.R0, nrow = number.families)
cc.Pn.100.mut.medium = matrix(ncol = number.R0, nrow = number.families)

cc.MSF.exp.mut = matrix(ncol = number.R0, nrow = number.families)
cc.MSF.exp.medium = matrix(ncol = number.R0, nrow = number.families)
cc.MSF.mut.medium = matrix(ncol = number.R0, nrow = number.families)

cc.nH.exp.mut = matrix(ncol = number.R0, nrow = number.families)
cc.nH.exp.medium = matrix(ncol = number.R0, nrow = number.families)
cc.nH.mut.medium = matrix(ncol = number.R0, nrow = number.families)

cc.nH.100.exp.mut = matrix(ncol = number.R0, nrow = number.families)
cc.nH.100.exp.medium = matrix(ncol = number.R0, nrow = number.families)
cc.nH.100.mut.medium = matrix(ncol = number.R0, nrow = number.families)

# satart a loop for each family
for (f in (1:nrow(input))) { 
  family <- as.character(input$family)[f]
  type <- as.character(input$type)[f]
  p.ref <- as.character(input$p.ref)[f]
  enm <- as.character(input$enm)[f]
  n.mut.p <- input$n.mut.p[f]
  R0.CA = input$R0.CA[f]
  R0.CM = input$R0.CM[f]
  chain.p.ref <- as.character(input$chain.p.ref)[f]

  for (R0 in (R0S)) {

    ### z.RSD ###
    
    # set input filenames
    dri2.exp.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.exp.norm.dr.squarei.csv", sep = ""))
    dri2.medium.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_medium.sel_K.analysis_Keff_out_m.theo.norm.dr.squarei.csv", sep = ""))
    dri2.mut.fname = file.path(data.dir,paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.theo.norm.dr.squarei.csv", sep = ""))
    
    # read data
    dri2.exp = read.csv(dri2.exp.fname, header = T)
    dri2.mut = read.csv(dri2.mut.fname, header = T)
    dri2.medium = read.csv(dri2.medium.fname, header = T)
    n.sites = length(dri2.exp)
    
    # prepare data
    rownames(dri2.exp) = paste("mut", rownames(dri2.exp), sep = "")
    rownames(dri2.mut) = paste("mut", rownames(dri2.mut), sep = "")
    rownames(dri2.medium) = paste("mut", rownames(dri2.medium), sep = "")
    
    tdri2.exp = as.data.frame(t(as.matrix(dri2.exp)))
    tdri2.mut = as.data.frame(t(as.matrix(dri2.mut)))
    tdri2.medium = as.data.frame(t(as.matrix(dri2.medium)))
    
    site.info = seq(1:length(dri2.mut))
    
    tdri2.exp = cbind(site.info, tdri2.exp)
    tdri2.mut = cbind(site.info, tdri2.mut)
    tdri2.medium = cbind(site.info, tdri2.medium)
    
    siteComparison.exp = melt(tdri2.exp, id.vars = c("site.info"), variable.name = "protein", value.name = "dri2")
    siteComparison.mut = melt(tdri2.mut, id.vars = c("site.info"), variable.name = "protein", value.name = "dri2")
    siteComparison.medium = melt(tdri2.medium, id.vars = c("site.info"), variable.name = "protein", value.name = "dri2")
    
    # bluild the data.frame
    siteComparison.all.datasets = rbind(data.frame("dataset" = "exp", siteComparison.exp),
                                        data.frame("dataset" = "mut", siteComparison.mut),
                                        data.frame("dataset" = "medium", siteComparison.medium))
    
    siteComparison.all.datasets = ddply(siteComparison.all.datasets, c("dataset", "protein"), mutate,
                                        "n.SD" = dri2/mean(dri2, na.rm = T),
                                        "z.SD" = vscale(dri2),
                                        "RSD" = sqrt(dri2),
                                        "n.RSD" = RSD/mean(RSD, na.rm = T),
                                        "z.RSD" = vscale(RSD))
    
    dat = siteComparison.all.datasets
    dat$dataset = revalue(dat$dataset, c("medium" = "selection"))
    dat$dataset = revalue(dat$dataset, c("mut" = "no-selection"))
    
    ## dat with means and standard errors
    d = ddply(dat,c("dataset", "site.info"), function(x) {
        mean.z.RSD = mean(x$z.RSD, na.rm = T)
        ndata = sum(!is.na(x$z.RSD))
        se.z.RSD = sd(x$z.RSD, na.rm = T) / sqrt(ndata)
        data.frame(mean.z.RSD, ndata, se.z.RSD)
    })
    
    # calculate correlations berween profiles
    d.exp = subset(d, dataset == "exp")
    d.mut = subset(d, dataset == "no-selection")
    d.medium = subset(d, dataset == "selection")
    
    r.exp.mut = cor(d.exp$mean.z.RSD, d.mut$mean.z.RSD)
    r.exp.medium = cor(d.exp$mean.z.RSD, d.medium$mean.z.RSD)
    r.mut.medium = cor(d.mut$mean.z.RSD, d.medium$mean.z.RSD)
    
    cc.z.RSD.exp.mut[which(input$family == family), which(R0S == R0)] = r.exp.mut
    cc.z.RSD.exp.medium[which(input$family == family), which(R0S == R0)] = r.exp.medium
    cc.z.RSD.mut.medium[which(input$family == family), which(R0S == R0)] = r.mut.medium
    
    ### Pn ###
    
    # set input filenames
    Pn.exp.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.exp.Pn.csv", sep = ""))
    Pn.medium.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_medium.sel_K.analysis_Keff_out_m.theo.Pn.csv", sep = ""))
    Pn.mut.fname = file.path(data.dir,paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.theo.Pn.csv", sep = ""))
    
    # prepare the data
    Pn.exp = read.csv(Pn.exp.fname, header = T)
    rownames(Pn.exp) = paste("mut", rownames(Pn.exp), sep = "")
    Pn.mut = read.csv(Pn.mut.fname, header = T)
    rownames(Pn.mut) = paste("mut", rownames(Pn.mut), sep = "")
    Pn.medium = read.csv(Pn.medium.fname, header = T)
    rownames(Pn.medium) = paste("mut", rownames(Pn.medium), sep = "")
    
    mode = seq(ncol(Pn.medium))
    
    # Prepare modeComparison
    tPn.medium = as.data.frame(t(as.matrix(Pn.medium)))
    tPn.medium = cbind(data.frame("mode" = mode), tPn.medium)
    modeComparison.medium = melt(tPn.medium, "mode", variable.name = "protein", value.name = "Pn")
    modeComparison.medium = ddply(modeComparison.medium, "protein", mutate, "Pn" = Pn / mean(Pn, na.rm = T))
    
    tPn.mut = as.data.frame(t(as.matrix(Pn.mut)))
    tPn.mut = cbind(data.frame("mode" = mode), tPn.mut)
    modeComparison.mut = melt(tPn.mut, "mode", variable.name = "protein", value.name = "Pn")
    modeComparison.mut = ddply(modeComparison.mut, "protein", mutate, "Pn" = Pn / mean(Pn, na.rm = T))
    
    tPn.exp = as.data.frame(t(as.matrix(Pn.exp)))
    tPn.exp = cbind(data.frame("mode" = mode), tPn.exp)
    modeComparison.exp = melt(tPn.exp, "mode", variable.name = "protein", value.name = "Pn")
    modeComparison.exp = ddply(modeComparison.exp, "protein", mutate, "Pn" = Pn / mean(Pn, na.rm = T))
    
    # modeComparison.exp has NA's because for proteins with gaps when using Keff there're less modes
    #print("Warning: modeComparison.exp <- na.omit(modeComparison.exp)")
    modeComparison.exp <- na.omit(modeComparison.exp)
    modeComparison.medium <- na.omit(modeComparison.medium)
    modeComparison.mut <- na.omit(modeComparison.mut)
    
    modeComparison.all.datasets = rbind(data.frame("dataset" = "exp", modeComparison.exp),
                                        data.frame("dataset" = "mut", modeComparison.mut),
                                        data.frame("dataset" = "medium", modeComparison.medium))
    
    dat = modeComparison.all.datasets
    dat$dataset = revalue(dat$dataset, c("medium" = "selection"))
    dat$dataset = revalue(dat$dataset, c("mut" = "no-selection"))
    
    # calculate dataset of medians
    d = ddply(dat,c("dataset", "mode"), function(x) {
        median.Pn = median(x$Pn)
        data.frame(median.Pn)
    })
    
    # calculate correlations berween profiles
    d.exp = subset(d, dataset == "exp")
    d.mut = subset(d, dataset == "no-selection")
    d.medium = subset(d, dataset == "selection")
    
    r.exp.mut = cor(d.exp$median.Pn, d.mut$median.Pn)
    r.exp.medium = cor(d.exp$median.Pn, d.medium$median.Pn)
    r.mut.medium = cor(d.mut$median.Pn, d.medium$median.Pn)
    
    cc.Pn.exp.mut[which(input$family == family), which(R0S == R0)] = r.exp.mut
    cc.Pn.exp.medium[which(input$family == family), which(R0S == R0)] = r.exp.medium
    cc.Pn.mut.medium[which(input$family == family), which(R0S == R0)] = r.mut.medium
    
    # 100 modes
    r.exp.mut = cor(d.exp$median.Pn[1:100], d.mut$median.Pn[1:100])
    r.exp.medium = cor(d.exp$median.Pn[1:100], d.medium$median.Pn[1:100])
    r.mut.medium = cor(d.mut$median.Pn[1:100], d.medium$median.Pn[1:100])
    
    cc.Pn.100.exp.mut[which(input$family == family), which(R0S == R0)] = r.exp.mut
    cc.Pn.100.exp.medium[which(input$family == family), which(R0S == R0)] = r.exp.medium
    cc.Pn.100.mut.medium[which(input$family == family), which(R0S == R0)] = r.mut.medium
    
    ### MSF ###
    
    # set input filenames
    square.dif.MSF.exp.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.exp.square.dif.MSF.csv", sep = ""))
    square.dif.MSF.medium.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_medium.sel_K.analysis_Keff_out_m.theo.square.dif.MSF.csv", sep = ""))
    square.dif.MSF.mut.fname = file.path(data.dir,paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.theo.square.dif.MSF.csv", sep = ""))
    
    # prepare the data
    square.dif.MSF.exp = read.csv(square.dif.MSF.exp.fname, header = T)
    rownames(square.dif.MSF.exp) = paste("mut", rownames(square.dif.MSF.exp), sep = "")
    square.dif.MSF.mut = read.csv(square.dif.MSF.mut.fname, header = T)
    rownames(square.dif.MSF.mut) = paste("mut", rownames(square.dif.MSF.mut), sep = "")
    square.dif.MSF.medium = read.csv(square.dif.MSF.medium.fname, header = T)
    rownames(square.dif.MSF.medium) = paste("mut", rownames(square.dif.MSF.medium), sep = "")
    
    site = seq(ncol(square.dif.MSF.medium))
    
    # Prepare siteComparison
    tsquare.dif.MSF.medium = as.data.frame(t(as.matrix(square.dif.MSF.medium)))
    tsquare.dif.MSF.medium = cbind(data.frame("site" = site), tsquare.dif.MSF.medium)
    siteComparison.medium = melt(tsquare.dif.MSF.medium, "site", variable.name = "protein", value.name = "square.dif.MSF")
    
    tsquare.dif.MSF.mut = as.data.frame(t(as.matrix(square.dif.MSF.mut)))
    tsquare.dif.MSF.mut = cbind(data.frame("site" = site), tsquare.dif.MSF.mut)
    siteComparison.mut = melt(tsquare.dif.MSF.mut, "site", variable.name = "protein", value.name = "square.dif.MSF")
    
    tsquare.dif.MSF.exp = as.data.frame(t(as.matrix(square.dif.MSF.exp)))
    tsquare.dif.MSF.exp = cbind(data.frame("site" = site), tsquare.dif.MSF.exp)
    siteComparison.exp = melt(tsquare.dif.MSF.exp, "site", variable.name = "protein", value.name = "square.dif.MSF")
    
    siteComparison.all.datasets = rbind(data.frame("dataset" = "exp", siteComparison.exp),
                                        data.frame("dataset" = "mut", siteComparison.mut),
                                        data.frame("dataset" = "medium", siteComparison.medium))
    
    siteComparison.all.datasets = ddply(siteComparison.all.datasets, c("dataset", "protein"), mutate,
                                             "r.SDF" = rank(square.dif.MSF, na.last = "keep")) 
    
    dat = siteComparison.all.datasets
    dat$dataset = revalue(dat$dataset, c("medium" = "selection"))
    dat$dataset = revalue(dat$dataset, c("mut" = "no-selection"))
    
    # calculate dataset of means
    d = ddply(dat, c("dataset", "site"), function(x) {
        mean.r.SDF = mean(x$r.SDF, na.rm = T)
        data.frame(mean.r.SDF)
    })
    
    # calculate correlations berween profiles
    d.exp = subset(d, dataset == "exp")
    d.mut = subset(d, dataset == "no-selection")
    d.medium = subset(d, dataset == "selection")
    
    r.exp.mut = cor(d.exp$mean.r.SDF, d.mut$mean.r.SDF)
    r.exp.medium = cor(d.exp$mean.r.SDF, d.medium$mean.r.SDF)
    r.mut.medium = cor(d.mut$mean.r.SDF, d.medium$mean.r.SDF)
    
    cc.MSF.exp.mut[which(input$family == family), which(R0S == R0)] = r.exp.mut
    cc.MSF.exp.medium[which(input$family == family), which(R0S == R0)] = r.exp.medium
    cc.MSF.mut.medium[which(input$family == family), which(R0S == R0)] = r.mut.medium
    
    ### nH ###
    # set input filenames
    nH.exp.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.exp.nH.csv", sep = ""))
    nH.medium.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_medium.sel_K.analysis_Keff_out_m.theo.nH.csv", sep = ""))
    nH.mut.fname = file.path(data.dir,paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.theo.nH.csv", sep = ""))
    
    # prepare the data
    nH.exp = read.csv(nH.exp.fname, header = T)
    rownames(nH.exp) = paste("mut", rownames(nH.exp), sep = "")
    nH.mut = read.csv(nH.mut.fname, header = T)
    rownames(nH.mut) = paste("mut", rownames(nH.mut), sep = "")
    nH.medium = read.csv(nH.medium.fname, header = T)
    rownames(nH.medium) = paste("mut", rownames(nH.medium), sep = "")
    
    mode = seq(ncol(nH.medium))
    
    # Prepare modeComparison
    tnH.medium = as.data.frame(t(as.matrix(nH.medium)))
    tnH.medium = cbind(data.frame("mode" = mode), tnH.medium)
    modeComparison.medium = melt(tnH.medium, "mode", variable.name = "protein", value.name = "nH")
    modeComparison.medium = ddply(modeComparison.medium, "protein", mutate, "nH" = nH / mean(nH, na.rm = T))
    
    tnH.mut = as.data.frame(t(as.matrix(nH.mut)))
    tnH.mut = cbind(data.frame("mode" = mode), tnH.mut)
    modeComparison.mut = melt(tnH.mut, "mode", variable.name = "protein", value.name = "nH")
    modeComparison.mut = ddply(modeComparison.mut, "protein", mutate, "nH" = nH / mean(nH, na.rm = T))
    
    tnH.exp = as.data.frame(t(as.matrix(nH.exp)))
    tnH.exp = cbind(data.frame("mode" = mode), tnH.exp)
    modeComparison.exp = melt(tnH.exp, "mode", variable.name = "protein", value.name = "nH")
    modeComparison.exp = ddply(modeComparison.exp, "protein", mutate, "nH" = nH / mean(nH, na.rm = T))
    
    # modeComparison.exp has NA's because for proteins with gaps when using Keff there're less modes
    #print("Warning: modeComparison.exp <- na.omit(modeComparison.exp)")
    modeComparison.exp <- na.omit(modeComparison.exp)
    modeComparison.medium <- na.omit(modeComparison.medium)
    modeComparison.mut <- na.omit(modeComparison.mut)
    
    modeComparison.all.datasets = rbind(data.frame("dataset" = "exp", modeComparison.exp),
                                        data.frame("dataset" = "mut", modeComparison.mut),
                                        data.frame("dataset" = "medium", modeComparison.medium))
    
    dat = modeComparison.all.datasets
    dat$dataset = revalue(dat$dataset, c("medium" = "selection"))
    dat$dataset = revalue(dat$dataset, c("mut" = "no-selection"))
    
    # calculate dataset of means
    d = ddply(dat,c("dataset", "mode"), function(x) {
        mean.nH = mean(x$nH)
        data.frame(mean.nH)
    })
    
    # calculate correlations berween profiles
    d.exp = subset(d, dataset == "exp")
    d.mut = subset(d, dataset == "no-selection")
    d.medium = subset(d, dataset == "selection")
    
    r.exp.mut = cor(d.exp$mean.nH, d.mut$mean.nH)
    r.exp.medium = cor(d.exp$mean.nH, d.medium$mean.nH)
    r.mut.medium = cor(d.mut$mean.nH, d.medium$mean.nH)
    
    cc.nH.exp.mut[which(input$family == family), which(R0S == R0)] = r.exp.mut
    cc.nH.exp.medium[which(input$family == family), which(R0S == R0)] = r.exp.medium
    cc.nH.mut.medium[which(input$family == family), which(R0S == R0)] = r.mut.medium
    
    # 100 modes
    r.exp.mut = cor(d.exp$mean.nH[1:100], d.mut$mean.nH[1:100])
    r.exp.medium = cor(d.exp$mean.nH[1:100], d.medium$mean.nH[1:100])
    r.mut.medium = cor(d.mut$mean.nH[1:100], d.medium$mean.nH[1:100])
    
    cc.nH.100.exp.mut[which(input$family == family), which(R0S == R0)] = r.exp.mut
    cc.nH.100.exp.medium[which(input$family == family), which(R0S == R0)] = r.exp.medium
    cc.nH.100.mut.medium[which(input$family == family), which(R0S == R0)] = r.mut.medium
  }
}

cc.z.RSD = data.frame(cc.z.RSD.exp.mut, cc.z.RSD.exp.medium, cc.z.RSD.mut.medium)
cc.z.RSD = cc.z.RSD
cc.z.RSD = rbind(cc.z.RSD, colMeans(cc.z.RSD))
family = as.character(input$family)
cc.z.RSD_CM = data.frame(c(family, "mean"), cc.z.RSD)
colnames(cc.z.RSD_CM) = c("family", paste("exp-mut-R0.", seq(1:number.R0), sep = ""), paste("exp-sel-R0.", seq(1:number.R0), sep = ""), paste("mut-sel-R0.", seq(1:number.R0), sep = ""))

write.csv(cc.z.RSD_CM, file = "cc_z.RSD_CM.csv")

cc.Pn = data.frame(cc.Pn.exp.mut, cc.Pn.exp.medium, cc.Pn.mut.medium)
cc.Pn = cc.Pn
cc.Pn = rbind(cc.Pn, colMeans(cc.Pn))
family = as.character(input$family)
cc.Pn_CM = data.frame(c(family, "mean"), cc.Pn)
colnames(cc.Pn_CM) = c("family", paste("exp-mut-R0.", seq(1:number.R0), sep = ""), paste("exp-sel-R0.", seq(1:number.R0), sep = ""), paste("mut-sel-R0.", seq(1:number.R0), sep = ""))

write.csv(cc.Pn_CM, file = "cc_Pn_CM.csv")

cc.Pn.100 = data.frame(cc.Pn.100.exp.mut, cc.Pn.100.exp.medium, cc.Pn.100.mut.medium)
cc.Pn.100 = cc.Pn.100
cc.Pn.100 = rbind(cc.Pn.100, colMeans(cc.Pn.100))
family = as.character(input$family)
cc.Pn.100_CM = data.frame(c(family, "mean"), cc.Pn.100)
colnames(cc.Pn.100_CM) = c("family", paste("exp-mut-R0.", seq(1:number.R0), sep = ""), paste("exp-sel-R0.", seq(1:number.R0), sep = ""), paste("mut-sel-R0.", seq(1:number.R0), sep = ""))

write.csv(cc.Pn.100_CM, file = "cc_Pn_100_CM.csv")

cc.MSF = data.frame(cc.MSF.exp.mut, cc.MSF.exp.medium, cc.MSF.mut.medium)
cc.MSF = cc.MSF
cc.MSF = rbind(cc.MSF, colMeans(cc.MSF))
family = as.character(input$family)
cc.MSF_CM = data.frame(c(family, "mean"), cc.MSF)
colnames(cc.MSF_CM) = c("family", paste("exp-mut-R0.", seq(1:number.R0), sep = ""), paste("exp-sel-R0.", seq(1:number.R0), sep = ""), paste("mut-sel-R0.", seq(1:number.R0), sep = ""))

write.csv(cc.MSF_CM, file = "cc_MSF_CM.csv")

cc.nH = data.frame(cc.nH.exp.mut, cc.nH.exp.medium, cc.nH.mut.medium)
cc.nH = cc.nH
cc.nH = rbind(cc.nH, colMeans(cc.nH))
family = as.character(input$family)
cc.nH_CM = data.frame(c(family, "mean"), cc.nH)
colnames(cc.nH_CM) = c("family", paste("exp-mut-R0.", seq(1:number.R0), sep = ""), paste("exp-sel-R0.", seq(1:number.R0), sep = ""), paste("mut-sel-R0.", seq(1:number.R0), sep = ""))

write.csv(cc.nH_CM, file = "cc_nH_CM.csv")

cc.nH.100 = data.frame(cc.nH.100.exp.mut, cc.nH.100.exp.medium, cc.nH.100.mut.medium)
cc.nH.100 = cc.nH.100
cc.nH.100 = rbind(cc.nH.100, colMeans(cc.nH.100))
family = as.character(input$family)
cc.nH.100_CM = data.frame(c(family, "mean"), cc.nH.100)
colnames(cc.nH.100_CM) = c("family", paste("exp-mut-R0.", seq(1:number.R0), sep = ""), paste("exp-sel-R0.", seq(1:number.R0), sep = ""), paste("mut-sel-R0.", seq(1:number.R0), sep = ""))

write.csv(cc.nH.100_CM, file = "cc_nH_100_CM.csv")
```

```{r prepare-site-data-plot-z.RSD}
# set
n.sets = ncol(cc.z.RSD_CA)- 1

# CA
# prepare the data
cc.z.RSD_CA = cc.z.RSD_CA[1:number.families, 2:ncol(cc.z.RSD_CA)]
c.R0 = rep(rep(paste("R0.", seq(number.R0), sep = ""), n.sets/number.R0), number.families)
comparison = rep(c(rep("exp vs mut",  number.R0), rep("exp vs selection", number.R0), rep("selection vs no-selection",  number.R0)), number.families)
df.cc.z.RSD_CA = cbind(data.frame("comparison" = comparison, "c.R0" = c.R0), cc.z.RSD = c(t(cc.z.RSD_CA)))

## comparison mut - sel
plot(x = cc.z.RSD_CA[,3], y = cc.z.RSD_CA[,6], xlab = "cc <z.RSD> exp - <z.RSD> no-selection", ylab = "cc <z.RSD> exp - <z.RSD> selection")
abline(0,1)
legend("topleft", paste ("r = ", round(cor(cc.z.RSD_CA[,3], cc.z.RSD_CA[,6]), digits = 2)), bty = "n")

dat = df.cc.z.RSD_CA

d = ddply(dat,c("comparison", "c.R0"), function(x) {
    cc.mean = mean(x$cc.z.RSD)
    cc.sd = sd(x$cc.z.RSD)
    data.frame(cc.mean, cc.sd)
})

## prepare plots with mean profiles and deviations
limits <- aes(ymax = d$cc.mean + d$cc.sd,
              ymin = d$cc.mean - d$cc.sd)
ggplot(d, aes(x = c.R0, y = cc.mean, col = comparison, fill = comparison)) +
  labs(x = "R0", y = "<cc z.RSD CA>") +
  geom_bar(stat = "identity",
      position = position_dodge(0.9)) +
      geom_errorbar(limits, position = position_dodge(0.9),
                               width = 0.25,
                               col = "black") 
# CM
cc.z.RSD_CM = cc.z.RSD_CM[1:number.families, 2:ncol(cc.z.RSD_CM)]
df.cc.z.RSD_CM = cbind(data.frame("comparison" = comparison, "c.R0" = c.R0), cc.z.RSD = c(t(cc.z.RSD_CM)))

dat = df.cc.z.RSD_CM

d = ddply(dat,c("comparison", "c.R0"), function(x) {
  cc.mean = mean(x$cc.z.RSD)
  cc.sd = sd(x$cc.z.RSD)
  data.frame(cc.mean, cc.sd)
})

## prepare plots with mean profiles and deviations
limits <- aes(ymax = d$cc.mean + d$cc.sd,
              ymin = d$cc.mean - d$cc.sd)
ggplot(d, aes(x = c.R0, y = cc.mean, col = comparison, fill = comparison)) +
  labs(x = "R0", y = "<cc z.RSD CM>") +
  geom_bar(stat = "identity",
      position = position_dodge(0.9)) +
      geom_errorbar(limits, position = position_dodge(0.9),
                               width = 0.25,
                               col = "black") 
```

```{r prepare-site-data-plot-Pn}
# CA
# prepare the data
cc.Pn_CA = cc.Pn_CA[1:number.families, 2:ncol(cc.Pn_CA)]
df.cc.Pn_CA = cbind(data.frame("comparison" = comparison, "c.R0" = c.R0), cc.Pn = c(t(cc.Pn_CA)))

plot(x = cc.Pn_CA[,3], y = cc.Pn_CA[,6], xlab = "cc <Pn> exp -  <Pn> no-selection", ylab = "cc <Pn> exp -  <Pn> selection")
abline(0,1)
legend("topleft", paste ("r = ", round(cor(cc.Pn_CA[,3], cc.Pn_CA[,6]), digits = 2)), bty = "n")


dat = df.cc.Pn_CA

d = ddply(dat,c("comparison", "c.R0"), function(x) {
    cc.mean = mean(x$cc.Pn)
    cc.sd = sd(x$cc.Pn)
    data.frame(cc.mean, cc.sd)
})

## prepare plots with mean profiles and deviations
limits <- aes(ymax = d$cc.mean + d$cc.sd,
              ymin = d$cc.mean - d$cc.sd)
ggplot(d, aes(x = c.R0, y = cc.mean, col = comparison, fill = comparison)) +
  labs(x = "R0", y = "<cc Pn CA>") +
  geom_bar(stat = "identity",
      position = position_dodge(0.9)) +
      geom_errorbar(limits, position = position_dodge(0.9),
                               width = 0.25,
                               col = "black") 
# CM
cc.Pn_CM = cc.Pn_CM[1:number.families, 2:ncol(cc.Pn_CM)]
df.cc.Pn_CM = cbind(data.frame("comparison" = comparison, "c.R0" = c.R0), cc.Pn = c(t(cc.Pn_CM)))

dat = df.cc.Pn_CM

d = ddply(dat,c("comparison", "c.R0"), function(x) {
  cc.mean = mean(x$cc.Pn)
  cc.sd = sd(x$cc.Pn)
  data.frame(cc.mean, cc.sd)
})

## prepare plots with mean profiles and deviations
limits <- aes(ymax = d$cc.mean + d$cc.sd,
              ymin = d$cc.mean - d$cc.sd)
ggplot(d, aes(x = c.R0, y = cc.mean, col = comparison, fill = comparison)) +
  labs(x = "R0", y = "<cc Pn CM>") +
  geom_bar(stat = "identity",
      position = position_dodge(0.9)) +
      geom_errorbar(limits, position = position_dodge(0.9),
                               width = 0.25,
                               col = "black") 
```

```{r prepare-site-data-plot-Pn.100}
# CA
# prepare the data
cc.Pn.100_CA = cc.Pn.100_CA[1:number.families, 2:ncol(cc.Pn.100_CA)]
df.cc.Pn.100_CA = cbind(data.frame("comparison" = comparison, "c.R0" = c.R0), cc.Pn.100 = c(t(cc.Pn.100_CA)))

dat = df.cc.Pn.100_CA

d = ddply(dat,c("comparison", "c.R0"), function(x) {
    cc.mean = mean(x$cc.Pn.100)
    cc.sd = sd(x$cc.Pn.100)
    data.frame(cc.mean, cc.sd)
})

## prepare plots with mean profiles and deviations
limits <- aes(ymax = d$cc.mean + d$cc.sd,
              ymin = d$cc.mean - d$cc.sd)
ggplot(d, aes(x = c.R0, y = cc.mean, col = comparison, fill = comparison)) +
  labs(x = "R0", y = "<cc Pn.100 CA>") +
  geom_bar(stat = "identity",
      position = position_dodge(0.9)) +
      geom_errorbar(limits, position = position_dodge(0.9),
                               width = 0.25,
                               col = "black") 
# CM
cc.Pn.100_CM = cc.Pn.100_CM[1:number.families, 2:ncol(cc.Pn.100_CM)]
df.cc.Pn.100_CM = cbind(data.frame("comparison" = comparison, "c.R0" = c.R0), cc.Pn.100 = c(t(cc.Pn.100_CM)))

dat = df.cc.Pn.100_CM

d = ddply(dat,c("comparison", "c.R0"), function(x) {
  cc.mean = mean(x$cc.Pn.100)
  cc.sd = sd(x$cc.Pn.100)
  data.frame(cc.mean, cc.sd)
})

## prepare plots with mean profiles and deviations
limits <- aes(ymax = d$cc.mean + d$cc.sd,
              ymin = d$cc.mean - d$cc.sd)
ggplot(d, aes(x = c.R0, y = cc.mean, col = comparison, fill = comparison)) +
  labs(x = "R0", y = "<cc Pn.100 CM>") +
  geom_bar(stat = "identity",
      position = position_dodge(0.9)) +
      geom_errorbar(limits, position = position_dodge(0.9),
                               width = 0.25,
                               col = "black") 
```

```{r prepare-site-data-plot-MSF}
# CA
# prepare the data
cc.MSF_CA = cc.MSF_CA[1:number.families, 2:ncol(cc.MSF_CA)]
df.cc.MSF_CA = cbind(data.frame("comparison" = comparison, "c.R0" = c.R0), cc.MSF = c(t(cc.MSF_CA)))

## comparison mut - sel
plot(x = cc.MSF_CA[,3], y = cc.MSF_CA[,6], xlab = "cc <MSF> exp - <MSF> no-selection", ylab = "cc <MSF> exp -  <MSF> selection")
abline(0,1)
legend("topleft", paste ("r = ", round(cor(cc.MSF_CA[,3], cc.MSF_CA[,6]), digits = 2)), bty = "n")


dat = df.cc.MSF_CA

d = ddply(dat,c("comparison", "c.R0"), function(x) {
    cc.mean = mean(x$cc.MSF)
    cc.sd = sd(x$cc.MSF)
    data.frame(cc.mean, cc.sd)
})

## prepare plots with mean profiles and deviations
limits <- aes(ymax = d$cc.mean + d$cc.sd,
              ymin = d$cc.mean - d$cc.sd)
ggplot(d, aes(x = c.R0, y = cc.mean, col = comparison, fill = comparison)) +
  labs(x = "R0", y = "<cc r.MSF CA>") +
  geom_bar(stat = "identity",
      position = position_dodge(0.9)) +
      geom_errorbar(limits, position = position_dodge(0.9),
                               width = 0.25,
                               col = "black") 
# CM
cc.MSF_CM = cc.MSF_CM[1:number.families, 2:ncol(cc.MSF_CM)]
df.cc.MSF_CM = cbind(data.frame("comparison" = comparison, "c.R0" = c.R0), cc.MSF = c(t(cc.MSF_CM))) 

dat = df.cc.MSF_CM

d = ddply(dat,c("comparison", "c.R0"), function(x) {
  cc.mean = mean(x$cc.MSF)
  cc.sd = sd(x$cc.MSF)
  data.frame(cc.mean, cc.sd)
})

## prepare plots with mean profiles and deviations
limits <- aes(ymax = d$cc.mean + d$cc.sd,
              ymin = d$cc.mean - d$cc.sd)
ggplot(d, aes(x = c.R0, y = cc.mean, col = comparison, fill = comparison)) +
  labs(x = "R0", y = "<cc r.MSF CM>") +
  geom_bar(stat = "identity",
      position = position_dodge(0.9)) +
      geom_errorbar(limits, position = position_dodge(0.9),
                               width = 0.25,
                               col = "black") 
```

```{r prepare-site-data-plot-nH}
# CA
# prepare the data
cc.nH_CA = cc.nH_CA[1:number.families, 2:ncol(cc.nH_CA)]
df.cc.nH_CA = cbind(data.frame("comparison" = comparison, "c.R0" = c.R0), cc.nH = c(t(cc.nH_CA)))

## comparison mut - sel
plot(x = cc.nH_CA[,3], y = cc.nH_CA[,6], xlab = "cc <nH> exp -  <MSF> no-selection", ylab = "cc <nH> exp -  <MSF> selection")
abline(0,1)
legend("topleft", paste ("r = ", round(cor(cc.nH_CA[,3], cc.nH_CA[,6]), digits = 2)), bty = "n")

dat = df.cc.nH_CA

d = ddply(dat,c("comparison", "c.R0"), function(x) {
    cc.mean = mean(x$cc.nH)
    cc.sd = sd(x$cc.nH)
    data.frame(cc.mean, cc.sd)
})

## prepare plots with mean profiles and deviations
limits <- aes(ymax = d$cc.mean + d$cc.sd,
              ymin = d$cc.mean - d$cc.sd)
ggplot(d, aes(x = c.R0, y = cc.mean, col = comparison, fill = comparison)) +
  labs(x = "R0", y = "<cc nH CA>") +
  geom_bar(stat = "identity",
      position = position_dodge(0.9)) +
      geom_errorbar(limits, position = position_dodge(0.9),
                               width = 0.25,
                               col = "black") 
# CM
cc.nH_CM = cc.nH_CM[1:number.families, 2:ncol(cc.nH_CM)]
df.cc.nH_CM = cbind(data.frame("comparison" = comparison, "c.R0" = c.R0), cc.nH = c(t(cc.nH_CM)))

dat = df.cc.nH_CM

d = ddply(dat,c("comparison", "c.R0"), function(x) {
  cc.mean = mean(x$cc.nH)
  cc.sd = sd(x$cc.nH)
  data.frame(cc.mean, cc.sd)
})

## prepare plots with mean profiles and deviations
limits <- aes(ymax = d$cc.mean + d$cc.sd,
              ymin = d$cc.mean - d$cc.sd)
ggplot(d, aes(x = c.R0, y = cc.mean, col = comparison, fill = comparison)) +
  labs(x = "R0", y = "<cc nH CM>") +
  geom_bar(stat = "identity",
      position = position_dodge(0.9)) +
      geom_errorbar(limits, position = position_dodge(0.9),
                               width = 0.25,
                               col = "black") 
```

```{r prepare-site-data-plot-nH.100}
# CA
# prepare the data
cc.nH.100_CA = cc.nH.100_CA[1:number.families, 2:ncol(cc.nH.100_CA)]
df.cc.nH.100_CA = cbind(data.frame("comparison" = comparison, "c.R0" = c.R0), cc.nH.100 = c(t(cc.nH.100_CA)))

dat = df.cc.nH.100_CA

d = ddply(dat,c("comparison", "c.R0"), function(x) {
    cc.mean = mean(x$cc.nH.100)
    cc.sd = sd(x$cc.nH.100)
    data.frame(cc.mean, cc.sd)
})

## prepare plots with mean profiles and deviations
limits <- aes(ymax = d$cc.mean + d$cc.sd,
              ymin = d$cc.mean - d$cc.sd)
ggplot(d, aes(x = c.R0, y = cc.mean, col = comparison, fill = comparison)) +
  labs(x = "R0", y = "<cc nH.100 CA>") +
  geom_bar(stat = "identity",
      position = position_dodge(0.9)) +
      geom_errorbar(limits, position = position_dodge(0.9),
                               width = 0.25,
                               col = "black") 
# CM
cc.nH.100_CM = cc.nH.100_CM[1:number.families, 2:ncol(cc.nH.100_CM)]
df.cc.nH.100_CM = cbind(data.frame("comparison" = comparison, "c.R0" = c.R0), cc.nH.100 = c(t(cc.nH.100_CM)))

dat = df.cc.nH.100_CM

d = ddply(dat,c("comparison", "c.R0"), function(x) {
  cc.mean = mean(x$cc.nH.100)
  cc.sd = sd(x$cc.nH.100)
  data.frame(cc.mean, cc.sd)
})

## prepare plots with mean profiles and deviations
limits <- aes(ymax = d$cc.mean + d$cc.sd,
              ymin = d$cc.mean - d$cc.sd)
ggplot(d, aes(x = c.R0, y = cc.mean, col = comparison, fill = comparison)) +
  labs(x = "R0", y = "<cc nH.100 CM>") +
  geom_bar(stat = "identity",
      position = position_dodge(0.9)) +
      geom_errorbar(limits, position = position_dodge(0.9),
                               width = 0.25,
                               col = "black") 
```