---
title: "Structural Divergence Analysis"
author: "Maria Laura Marcos, Julian Echave"
output: html_document
---

# Introduction
We study the evolutionary divergence of proteins using the LF-ENM and comparing simulated mutants with experimental data.

```{r setup, include = FALSE}
# set chunk options
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r load_packages}
# load packages
library(ggplot2)
library(reshape2)
library(plyr)
library(quantreg)
library(bio3d)

# load functions
source(file.path(data.dir, "multiplot.R"))
source(file.path(data.dir, "my-functions.R")) 
```

```{r set_my_colors}
# set my colors
myColors = c("blue", "darkgreen", "red", "red") 
names(myColors) <- c("exp", "mut", "strong", "mut+sel")
```

```{r set_run_variables}
# set significance factors
f95 = 1.96
f99 = 2.6
f999 = 3.3
```

```{r set_file_names}
# set input filenames
## data
reference.fname = file.path(data.dir, paste(family, "_ref.txt", sep = ""))
protein_list.fname = file.path(data.dir, paste(family, "_list.txt", sep = ""))
site.info.fname = file.path(data.dir, paste(p.ref, "_m.da.ca.csv", sep = ""))
min.da.CM.CA.fname = file.path(data.dir, paste(p.ref, "_min.da.CM.ca.csv", sep = ""))

## profiles to compare
### Pn
Pn.exp.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.exp.Pn.csv", sep = ""))
Pn.strong.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_strong.sel_K.analysis_Keff_out_m.theo.Pn.csv", sep = ""))
Pn.mut.fname = file.path(data.dir,paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.theo.Pn.csv", sep = ""))

### energy
energy.exp.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.exp.va.csv", sep = ""))
energy.strong.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_strong.sel_K.analysis_Keff_out_m.theo.va.csv", sep = ""))
energy.mut.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.theo.va.csv", sep = ""))

```

```{r set_reference_protein}
# which is the reference protein?
reference = as.character(read.table(reference.fname, header = F)[1, 1])
if (reference != p.ref) {
  print("Warning: different references")
}
```

We studied the `r family` family. 
We used the ENM `r enm` with R0 = `r R0` to generate mutants.
We used as reference for the ENM the protein with pdb code `r reference`. 
We simulated `r n.mut.p` mutants of this reference for each protein of the family.
The `r family` family is of the type `r type` and consists of the following proteins:

```{r set_experimental_protein_names, comment = ""}
# experimental protein names
protein.exp = read.table(protein_list.fname, header = F, stringsAsFactors = F)[, 1]
protein.exp = protein.exp[protein.exp != reference]
print(protein.exp)
```

```{r prepare_site_data}
# prepare the data
Pn.exp = read.csv(Pn.exp.fname, header = T)
rownames(Pn.exp) = protein.exp
energy.exp = read.csv(energy.exp.fname, header = T)
rownames(energy.exp) = protein.exp

Pn.mut = read.csv(Pn.mut.fname, header = T)
rownames(Pn.mut) = paste("mut", rownames(Pn.mut), sep = "")
energy.mut = read.csv(energy.mut.fname, header = T)
rownames(energy.mut) = paste("mut", rownames(energy.mut), sep = "")

Pn.strong = read.csv(Pn.strong.fname, header = T)
rownames(Pn.strong) = paste("strong", rownames(Pn.strong), sep = "")
energy.strong = read.csv(energy.strong.fname, header = T)
rownames(energy.strong) = paste("strong", rownames(energy.strong), sep = "")

```

### Structural divergence along normal modes

In this section we consider structural divergence using normal mode coordinates. Pn is the square divergence along a normal mode relative to the mean.

```{r prepare-mode-data}
mode = seq(ncol(Pn.strong))

# Prepare modeComparison.strong
tPn.strong = as.data.frame(t(as.matrix(Pn.strong)))
tPn.strong = cbind(data.frame("mode" = mode), tPn.strong)
Pn.strong.long = melt(tPn.strong, "mode", variable.name = "protein", value.name = "Pn")

tenergy.strong = as.data.frame(t(as.matrix(energy.strong)))
tenergy.strong = cbind(data.frame("mode" = mode), tenergy.strong)
energy.strong.long = melt(tenergy.strong, "mode", variable.name = "protein", value.name = "energy")
energy.strong.long$sn2 = 1/energy.strong.long$energy

modeComparison.strong = merge(energy.strong.long, Pn.strong.long, by = c("mode", "protein"))
modeComparison.strong = ddply(modeComparison.strong, "protein", mutate, "Pn" = Pn / mean(Pn, na.rm = T))

# Prepare modeComparison.mut
tPn.mut = as.data.frame(t(as.matrix(Pn.mut)))
tPn.mut = cbind(data.frame("mode" = mode), tPn.mut)
Pn.mut.long = melt(tPn.mut, "mode", variable.name = "protein", value.name = "Pn")

tenergy.mut = as.data.frame(t(as.matrix(energy.mut)))
tenergy.mut = cbind(data.frame("mode" = mode), tenergy.mut)
energy.mut.long = melt(tenergy.mut, "mode", variable.name = "protein", value.name = "energy")
energy.mut.long$sn2 = 1/energy.mut.long$energy

modeComparison.mut = merge(energy.mut.long, Pn.mut.long, by = c("mode", "protein"))
modeComparison.mut = ddply(modeComparison.mut, "protein", mutate, "Pn" = Pn / mean(Pn, na.rm = T))

# Prepare modeComparison.exp
tPn.exp = as.data.frame(t(as.matrix(Pn.exp)))
tPn.exp = cbind(data.frame("mode" = mode), tPn.exp)
Pn.exp.long = melt(tPn.exp, "mode", variable.name = "protein", value.name = "Pn")

tenergy.exp = as.data.frame(t(as.matrix(energy.exp)))
tenergy.exp = cbind(data.frame("mode" = mode), tenergy.exp)
energy.exp.long = melt(tenergy.exp, "mode", variable.name = "protein", value.name = "energy")
energy.exp.long$sn2 = 1/energy.exp.long$energy

modeComparison.exp = merge(energy.exp.long,Pn.exp.long,by=c("mode", "protein"))
# renormalize Pn
modeComparison.exp = ddply(modeComparison.exp, "protein", mutate, "Pn" = Pn / mean(Pn, na.rm = T))

# modeComparison.exp has NA's because for proteins with gaps when using Keff there're less modes
#print("Warning: modeComparison.exp <- na.omit(modeComparison.exp)")
modeComparison.exp <- na.omit(modeComparison.exp)
modeComparison.strong <- na.omit(modeComparison.strong)
modeComparison.mut <- na.omit(modeComparison.mut)
```


```{r add-quantile-regression-data}

## Quantile regression 

# fit median and quantiles to simulated data and add them to data.frames
fit.strong.rq.5 <- rq(Pn ~ sn2, tau = .5, data = modeComparison.strong, method = "fn")
fit.strong.rq.05 <- rq(Pn ~ sn2, tau = .05, data = modeComparison.strong, method = "fn")
fit.strong.rq.95 <- rq(Pn ~ sn2, tau = .95, data = modeComparison.strong, method = "fn")
modeComparison.strong$rq.5 = fit.strong.rq.5$fitted.values
modeComparison.strong$rq.05 = fit.strong.rq.05$fitted.values
modeComparison.strong$rq.95 = fit.strong.rq.95$fitted.values

# fit median and quantiles to simulated data and add them to data.frames
fit.mut.rq.5 <- rq(Pn ~ sn2, tau = .5, data = modeComparison.mut, method = "fn")
fit.mut.rq.05 <- rq(Pn ~ sn2, tau = .05, data = modeComparison.mut, method = "fn")
fit.mut.rq.95 <- rq(Pn ~ sn2, tau = .95, data = modeComparison.mut, method = "fn")
modeComparison.mut$rq.5 = fit.mut.rq.5$fitted.values
modeComparison.mut$rq.05 = fit.mut.rq.05$fitted.values
modeComparison.mut$rq.95 = fit.mut.rq.95$fitted.values

# fit median and quantiles to experimental data
fit.exp.rq.5 <- rq(Pn ~ sn2, tau = .5, data = modeComparison.exp, method = "fn")
fit.exp.rq.05 <- rq(Pn ~ sn2, tau = .05, data = modeComparison.exp, method = "fn")
fit.exp.rq.95 <- rq(Pn ~ sn2, tau = .95, data = modeComparison.exp, method = "fn")
modeComparison.exp$rq.5 = fit.exp.rq.5$fitted.values
modeComparison.exp$rq.05 = fit.exp.rq.05$fitted.values
modeComparison.exp$rq.95 = fit.exp.rq.95$fitted.values

# put simulated and experimental data together

modeComparison.all.datasets = rbind(data.frame("dataset" = "exp", modeComparison.exp),
                                    data.frame("dataset" = "mut", modeComparison.mut),
                                    data.frame("dataset" = "strong", modeComparison.strong))

modeComparison.all.datasets$dataset = factor(modeComparison.all.datasets$dataset, levels = c("exp", "mut", "strong"))
```
### Pn vs. mode energy

Note: lines are the median, 0.05 and 0.95 quantiles fit using rq(Pn ~ sn2). sn2 = 1/energy is the expected MSD of along mode n. The mean value of Pn should be a linear function of sn2 (Pn is normalized, sn2 is not).

Here we show the square deviation along each normal mode (normalized so that = 1) vs. the normal-mode's energy. For the empirical data, we use the actual energy obtained from Keff for the given comparison. It is this energy the one that should be used, since it's inverse is the expected value of Pn. Lines are the .5 (median), .05, and .95 quantiles obtained using rq()

Upper panel: simulated vs empirical data, shown separately.
Lower panel: simulated vs empirical overlaped and zoomed to better see the pattern.

```{r Pn-vs-energy}

# Plot Pn vs energy
dat = modeComparison.all.datasets
dat$dataset = revalue(dat$dataset,c("strong" = "mut+sel"))

# p is just the median and quantiles
p.points.rq = ggplot(dat, aes(x = energy, y = Pn, col = dataset)) + 
    geom_point(alpha = .4, size = .2) +
    geom_line(aes(y = rq.5)) +
    geom_line(aes(y = rq.05)) +
    geom_line(aes(y = rq.95)) 
p = p.points.rq +  
    labs(x = "mode energy", y = "structural divergence") +
    coord_cartesian(xlim = c(0,2.5)) +
    scale_colour_manual(name = NULL, values = myColors) + 
    scale_fill_manual(name=NULL, values = myColors)

p.facet = p + facet_grid(dataset~., switch = "y") + theme(legend.position = "none")
p.facet %+% subset(dat, dataset == "exp")
p.facet %+% subset(dat, dataset == "mut")
p.facet %+% subset(dat, dataset == "mut+sel")
p.facet
```

### median(Pn) vs mode energy

```{r median-vs-mode-energy}

dat = modeComparison.all.datasets
dat$dataset = revalue(dat$dataset,c("strong" = "mut+sel"))

# calculate dataset of medians

dat = ddply(dat,c("dataset", "mode"), function(x) {
    energy.mean = mean(x$energy)
    Pn.median = median(x$Pn)
    Pn.median.ci = sort(x$Pn)[qbinom(c(.025, .975), length(x$Pn), 0.5)]
    Pn.median.min = Pn.median.ci[1]
    Pn.median.max = Pn.median.ci[2]
    rq.5 = mean(x$rq.5)
    data.frame(energy.mean, Pn.median.min, Pn.median.max, Pn.median, rq.5)
})

p = ggplot(dat,aes(x=energy.mean,y=Pn.median,col=dataset,fill=dataset)) +
    geom_pointrange(aes(ymin=Pn.median.min,ymax = Pn.median.max),size=.2,alpha=.4) +
    geom_line(aes(y=rq.5))  +
    labs(x="mode energy",y="structural divergence (median Pn) ") +
    scale_colour_manual(name = NULL,values = myColors) + 
    scale_fill_manual(name=NULL,values=myColors)+
    coord_cartesian(xlim=c(0,1)) 


p.facet = p + facet_grid(dataset~., switch = "y") + theme(legend.position = "none")
p.facet %+% subset(dat,dataset == "exp")
p.facet %+% subset(dat,dataset == "mut")
p.facet %+% subset(dat,dataset == "mut+sel")
p.facet
p + theme(legend.position = "bottom")

```

### correlaction between mode profiles

```{r correlation-mode-profiles}
dat = modeComparison.all.datasets
#dat$dataset = revalue(dat$dataset,c("strong" = "mut+sel"))

# calculate dataset of medians
dat = ddply(dat, c("dataset", "mode"), function(x) {
    energy.mean = mean(x$energy)
    Pn.median = median(x$Pn)
    data.frame(energy.mean, Pn.median)
})

dat = subset(dat, mode < 101)
dat.exp = subset(dat, dataset == "exp")
dat.mut = subset(dat,dataset == "mut")
dat.strong = subset(dat,dataset == "strong")

r.exp.mut = cor(dat.exp$Pn.median, dat.mut$Pn.median)
r.exp.strong = cor(dat.exp$Pn.median, dat.strong$Pn.median)
r.mut.strong = cor(dat.mut$Pn.median, dat.strong$Pn.median)
cor.df = data.frame("comparison" = c("exp vs mut", "exp vs strong", "mut vs strong"),
                    "R" = c(r.exp.mut, r.exp.strong, r.mut.strong))
knitr::kable(cor.df, digits = 2)

# plot exp vs simulated profiles 
par(pty = "s")

plot(x = dat.exp$Pn.median, 
     y = dat.mut$Pn.median, 
     xlab = "exp.Pn.median", 
     ylab = "mut.Pn.median", 
     xlim = c(min(c(dat.exp$Pn.median, dat.mut$Pn.median)), max(c(dat.exp$Pn.median, dat.mut$Pn.median))),
     ylim = c(min(c(dat.exp$Pn.median, dat.mut$Pn.median)), max(c(dat.exp$Pn.median, dat.mut$Pn.median))))
abline(0, 1)

plot(x = dat.exp$Pn.median, 
     y = dat.strong$Pn.median, 
     xlab = "exp.Pn.median", 
     ylab = "strong.Pn.median", 
     xlim = c(min(c(dat.exp$Pn.median, dat.strong$Pn.median)), max(c(dat.exp$Pn.median, dat.strong$Pn.median))),
     ylim = c(min(c(dat.exp$Pn.median, dat.strong$Pn.median)), max(c(dat.exp$Pn.median, dat.strong$Pn.median))))
abline(0, 1)

plot(x = dat.mut$Pn.median, 
     y = dat.strong$Pn.median, 
     xlab = "mut.Pn.median", 
     ylab = "strong.Pn.median", 
     xlim = c(min(c(dat.mut$Pn.median, dat.strong$Pn.median)), max(c(dat.mut$Pn.median, dat.strong$Pn.median))),
     ylim = c(min(c(dat.mut$Pn.median, dat.strong$Pn.median)), max(c(dat.mut$Pn.median, dat.strong$Pn.median))))
abline(0, 1)
```
