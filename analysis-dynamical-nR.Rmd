---
title: "Structural Divergence Analysis"
author: "Maria Laura Marcos, Julian Echave"
output: html_document
---

# Introduction
We study the evolutionary divergence of proteins using the LF-ENM and comparing simulated mutants with experimental data.

```{r setup, include = FALSE}
# set chunk options
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r load_packages}
# load packages
library(ggplot2)
library(reshape2)
library(plyr)
library(quantreg)
library(bio3d)

# load functions
source(file.path(data.dir, "multiplot.R"))
source(file.path(data.dir, "my-functions.R")) 
```

```{r set_my_colors}
# set my colors
myColors = c("blue", "darkgreen", "red", "red") 
names(myColors) <- c("exp", "mut", "medium", "mut+sel")
```

```{r set_run_variables}
# set significance factors
f95 = 1.96
f99 = 2.6
f999 = 3.3
```

```{r set_file_names}
# set input filenames
## data
reference.fname = file.path(data.dir, paste(family, "_ref.txt", sep = ""))
protein_list.fname = file.path(data.dir, paste(family, "_list.txt", sep = ""))

## profiles to compare
### nR
nR.exp.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.exp.nR.csv", sep = ""))
nR.medium.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_medium.sel_K.analysis_Keff_out_m.theo.nR.csv", sep = ""))
nR.mut.fname = file.path(data.dir,paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.theo.nR.csv", sep = ""))

```

```{r set_reference_protein}
# which is the reference protein?
reference = as.character(read.table(reference.fname, header = F)[1, 1])
if (reference != p.ref) {
  print("Warning: different references")
}
```

We studied the `r family` family. 
We used the ENM `r enm` with R0 = `r R0` to generate mutants.
We used as reference for the ENM the protein with pdb code `r reference`. 
We simulated `r n.mut.p` mutants of this reference for each protein of the family.
The `r family` family is of the type `r type` and consists of the following proteins:

```{r set_experimental_protein_names, comment = ""}
# experimental protein names
protein.exp = read.table(protein_list.fname, header = F, stringsAsFactors = F)[, 1]
protein.exp = protein.exp[protein.exp != reference]
print(protein.exp)
```

```{r prepare_mode_data}
# prepare the data
nR.exp = read.csv(nR.exp.fname, header = T)
nR.mut = read.csv(nR.mut.fname, header = T)
nR.medium = read.csv(nR.medium.fname, header = T)
```

### Dynamical divergence along normal modes

In this section we consider dynamical divergence using normal modes coordinates. We calculated mean nR and we z-normalized profiles.

```{r comparison-of-means, fig.cap = "blue = experimental - green = no-selection - red = selection"}
# calculate means
mean.nR.exp = colMeans(nR.exp, na.rm = T)
mean.nR.mut = colMeans(nR.mut)
mean.nR.medium = colMeans(nR.medium)

# scale profiles
mean.nR.exp = scale(mean.nR.exp[which(!is.na(mean.nR.exp))])
mean.nR.mut = scale(mean.nR.mut[which(!is.na(mean.nR.mut))])
mean.nR.medium = scale(mean.nR.medium[which(!is.na(mean.nR.medium))])

plot(mean.nR.exp, ylab = "<nR>", xlab = "mode", col = "blue")
points(mean.nR.mut, col = "green")
points(mean.nR.medium, col = "red")

r.exp.mut = cor(mean.nR.exp, mean.nR.mut)
r.exp.medium = cor(mean.nR.exp, mean.nR.medium)
r.mut.medium = cor(mean.nR.mut, mean.nR.medium)

cor.df = data.frame("comparison" = c("exp vs no-selection", "exp vs selection", "no-selection vs selection"),
                    "R" = c(r.exp.mut, r.exp.medium, r.mut.medium))
knitr::kable(cor.df, digits = 2)
```

```{r vs-mean-profiles}

# plot exp vs simulated profiles 
par(pty = "s")

plot(x = mean.nR.exp, 
     y = mean.nR.mut, 
     xlab = "exp.mean.nR", 
     ylab = "no.selection.mean.nR")
abline(0, 1)

plot(x = mean.nR.exp, 
     y = mean.nR.medium, 
     xlab = "exp.mean.nR", 
     ylab = "selection.mean.nR")
abline(0, 1)

plot(x = mean.nR.mut, 
     y = mean.nR.medium, 
     xlab = "no.selection.mean.nR", 
     ylab = "selection.mean.nR")
abline(0, 1)
```

```{r comparison-of-means-100-modes}

# get first 100 modes and re-scale
mean.nR.exp = scale(mean.nR.exp[1:100])
mean.nR.mut = scale(mean.nR.mut[1:100])
mean.nR.medium = scale(mean.nR.medium[1:100])

plot(mean.nR.exp, ylab = "<nR>", xlab = "mode", col = "blue")
points(mean.nR.mut, col = "green")
points(mean.nR.medium, col = "red")

r.exp.mut = cor(mean.nR.exp, mean.nR.mut)
r.exp.medium = cor(mean.nR.exp, mean.nR.medium)
r.mut.medium = cor(mean.nR.mut, mean.nR.medium)

cor.df = data.frame("comparison" = c("exp vs no-selection", "exp vs selection", "no-selection vs selection"),
                    "R" = c(r.exp.mut, r.exp.medium, r.mut.medium))
knitr::kable(cor.df, digits = 2)

# plot exp vs simulated profiles 
par(pty = "s")

plot(x = mean.nR.exp, 
     y = mean.nR.mut, 
     xlab = "exp.mean.nR", 
     ylab = "no.selection.mean.nR")
abline(0, 1)

plot(x = mean.nR.exp, 
     y = mean.nR.medium, 
     xlab = "exp.mean.nR", 
     ylab = "selection.mean.nR")
abline(0, 1)

plot(x = mean.nR.mut, 
     y = mean.nR.medium, 
     xlab = "no.selection.mean.nR", 
     ylab = "selection.mean.nR")
abline(0, 1)
```