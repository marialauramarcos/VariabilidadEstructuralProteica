---
title: "Structural Divergence Analysis"
author: "Maria Laura Marcos, Julian Echave"
output: html_document
---

# Introduction
We study the evolutionary divergence of proteins using the LF-ENM and comparing simulated mutants with experimental data.

```{r setup, include = FALSE}
# set chunk options
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r load_packages}
# load packages
library(ggplot2)
library(reshape2)
library(plyr)
library(quantreg)
library(bio3d)

# load functions
source(file.path(data.dir, "multiplot.R"))
source(file.path(data.dir, "my-functions.R")) 
```

```{r set_my_colors}
# set my colors
myColors = c("blue", "darkgreen", "red", "red") 
names(myColors) <- c("exp", "mut", "medium", "mut+sel")
```

```{r set_run_variables}
# set significance factors
f95 = 1.96
f99 = 2.6
f999 = 3.3
```

```{r set_file_names}
# set input filenames
## data
reference.fname = file.path(data.dir, paste(family, "_ref.txt", sep = ""))
protein_list.fname = file.path(data.dir, paste(family, "_list.txt", sep = ""))
site.info.fname = file.path(data.dir, paste(p.ref, "_m.da.ca.csv", sep = ""))
min.da.CM.CA.fname = file.path(data.dir, paste(p.ref, "_min.da.CM.ca.csv", sep = ""))

## profiles to compare
### square.dif.MSF
square.dif.MSF.exp.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.exp.square.dif.MSF.csv", sep = ""))
square.dif.MSF.medium.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_medium.sel_K.analysis_Keff_out_m.theo.square.dif.MSF.csv", sep = ""))
square.dif.MSF.mut.fname = file.path(data.dir,paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.theo.square.dif.MSF.csv", sep = ""))

```

```{r set_reference_protein}
# which is the reference protein?
reference = as.character(read.table(reference.fname, header = F)[1, 1])
if (reference != p.ref) {
  print("Warning: different references")
}
```

We studied the `r family` family. 
We used the ENM `r enm` with R0 = `r R0` to generate mutants.
We used as reference for the ENM the protein with pdb code `r reference`. 
We simulated `r n.mut.p` mutants of this reference for each protein of the family.
The `r family` family is of the type `r type` and consists of the following proteins:

```{r set_experimental_protein_names, comment = ""}
# experimental protein names
protein.exp = read.table(protein_list.fname, header = F, stringsAsFactors = F)[, 1]
protein.exp = protein.exp[protein.exp != reference]
print(protein.exp)
```

```{r prepare_site_data}
# prepare the data
square.dif.MSF.exp = read.csv(square.dif.MSF.exp.fname, header = T)

square.dif.MSF.mut = read.csv(square.dif.MSF.mut.fname, header = T)

square.dif.MSF.medium = read.csv(square.dif.MSF.medium.fname, header = T)
```

### Dynamical divergence along sites

In this section we consider dynamical divergence using Cartessian coordinates. square.dif.MSF is the square diference between MSF of the proteins relative to the reference protein.


```{r comparisson-of-means}
# calculate means
mean.square.dif.MSF.exp = colMeans(square.dif.MSF.exp, na.rm = T)
mean.square.dif.MSF.mut = colMeans(square.dif.MSF.mut)
mean.square.dif.MSF.medium = colMeans(square.dif.MSF.medium)

# remove too divergent sites 
n.sites = length(mean.square.dif.MSF.exp)
mean.square.dif.MSF.exp = mean.square.dif.MSF.exp[-c(1,2,3,4,(n.sites-3), (n.sites-2), (n.sites-1), n.sites)]
mean.square.dif.MSF.mut = mean.square.dif.MSF.mut[-c(1,2,3,4,(n.sites-3), (n.sites-2), (n.sites-1), n.sites)]
mean.square.dif.MSF.medium = mean.square.dif.MSF.medium[-c(1,2,3,4,(n.sites-3), (n.sites-2), (n.sites-1), n.sites)]

# scale profiles
mean.square.dif.MSF.exp = rank(mean.square.dif.MSF.exp)
mean.square.dif.MSF.mut = rank(mean.square.dif.MSF.mut)
mean.square.dif.MSF.medium = rank(mean.square.dif.MSF.medium)

plot(mean.square.dif.MSF.exp, ylab = "Square dif MSF", xlab = "site", col = "blue")
points(mean.square.dif.MSF.mut, col = "green")
points(mean.square.dif.MSF.medium, col = "red")

r.exp.mut = cor(mean.square.dif.MSF.exp, mean.square.dif.MSF.mut)
r.exp.medium = cor(mean.square.dif.MSF.exp, mean.square.dif.MSF.medium)
r.mut.medium = cor(mean.square.dif.MSF.mut, mean.square.dif.MSF.medium)

cor.df = data.frame("comparison" = c("exp vs mut", "exp vs medium", "mut vs medium"),
                    "R" = c(r.exp.mut, r.exp.medium, r.mut.medium))
knitr::kable(cor.df, digits = 2)

# plot exp vs simulated profiles 
par(pty = "s")

plot(x = mean.square.dif.MSF.exp, 
     y = mean.square.dif.MSF.mut, 
     xlab = "exp.mean.square.dif.MSF", 
     ylab = "mut.mean.square.dif.MSF")
abline(0, 1)

plot(x = mean.square.dif.MSF.exp, 
     y = mean.square.dif.MSF.medium, 
     xlab = "exp.mean.square.dif.MSF", 
     ylab = "medium.mean.square.dif.MSF")
abline(0, 1)

plot(x = mean.square.dif.MSF.mut, 
     y = mean.square.dif.MSF.medium, 
     xlab = "mut.mean.square.dif.MSF", 
     ylab = "medium.mean.square.dif.MSF")
abline(0, 1)
```
