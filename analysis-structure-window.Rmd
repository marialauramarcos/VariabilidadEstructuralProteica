---
title: "Structural Divergence Analysis"
author: "Mar√≠a Laura Marcos, Julian Echave"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, autodep = T)
```

```{r load_packages}

# Load packages
library(ggplot2)
library(reshape2)
library(plyr)
library(quantreg)
library(bio3d)

# Load functions
source(file.path(data.dir, "multiplot.R"))
source(file.path(data.dir, "my-functions.R")) 
```

```{r set_my_colors, eval = T}
myColors = c("blue", "darkgreen", "red", "red") 
names(myColors) <- c("exp", "mut", "strong", "mut+sel")
```

# Introduction
We study the evolutionary divergence of proteins using the LF-ENM and comparing simulated mutants with experimental data.

```{r set_run_variables}
# significance factors
f95 = 1.96
f99 = 2.6
f999 = 3.3
```

```{r set_file_names}
# input and pre-processing of data

## set up input filenames
reference.fname = file.path(data.dir, paste(family, "_ref.txt", sep = ""))
protein_list.fname = file.path(data.dir, paste(family, "_list.txt", sep = ""))
site.info.fname = file.path(data.dir, paste(p.ref, "_m.da.ca.csv", sep = ""))
min.da.CM.ca.fname = file.path(data.dir, paste(p.ref, "_min.da.CM.ca.csv", sep = ""))

dri2.exp.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.exp.norm.dr.squarei.windows.rot.csv", sep = ""))

dri2.strong.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_strong.sel_K.analysis_Keff_out_m.theo.norm.dr.squarei.windows.rot.csv", sep = "")) #cambiar

dri2.mut.fname = file.path(data.dir,paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.theo.norm.dr.squarei.windows.rot.csv", sep = ""))
```

```{r set_reference_protein}
# which is the reference protein?
reference = as.character(read.table(reference.fname, header = F)[1, 1])
```

We studied the `r family` family. 
We used the ENM `r enm` with R0 = `r R0` to generate mutants.
We used as reference for the ENM the protein with pdb code `r reference`. 
We simulated `r n.mut.p` mutants of this reference for each protein of the family.
The `r family` family is of the type `r type` and consists of the following proteins:

```{r set_experimental_protein_names}
# experimental protein names
protein.exp = read.table(protein_list.fname, header = F, stringsAsFactors = F)[, 1]
protein.exp = protein.exp[protein.exp != reference]
print(protein.exp)
```

[//]: Prepare site.info data frame

```{r set_site_info, eval = T}
# read site information of reference protein
site.info = read.csv(site.info.fname, header = T, sep = ",")
m.min.da.CM.ca = read.csv(min.da.CM.ca.fname)

# add info to site.info
d = ddply(site.info, "site", .fun = function(x) data.frame("da" = min(x[, c(-1, -2)])))

# define shells of active site neighborhood (first shell is from 2.5 to 7.5, second from 7.5 to 12.5, etc)
d$shell = cut(d$da, breaks = c(-.1, 2.5, 7.5, 12.5, 17.5, 22.5, 27.5, 32.5, 37.5, 42.5, 47.5, 52.5, max(d$da)))
levels(d$shell) = seq(length(levels(d$shell))) - 1 # rename shell levels
site.info = merge(site.info, d, by = "site")

# read reference pdb and calculate resno, AA, and CN
reference.pdb.fname = file.path(data.dir,paste(reference, ".pdb", sep = ""))
ref.pdb = read.pdb(reference.pdb.fname)
inds = atom.select(ref.pdb, elety = "CA")
ref.pdb.ca = ref.pdb$atom[inds$atom,]
cmap.ca = cmap(ref.pdb$xyz[inds$xyz], dcut = R0, scut = 0, mask.lower = F)
CN = rowSums(cmap.ca, na.rm = T) - 1 # diag(cmap.ca) returned by cmap is 1!
AA = ref.pdb.ca$resid
resno = ref.pdb.ca$resno
pdb.info = data.frame(resno, AA, CN)
names(pdb.info) = c("resno", "AA", paste("CN", as.character(R0), sep = ""))

# add pdb.info to site.info
site.info = cbind(site.info, pdb.info)
```

[//]: Prepare experimental data

```{r read_experimental_data}
# read experimental data
dri2.exp = read.csv(dri2.exp.fname, header = T)
site = site.info$site
dri2.exp = dri2.exp[1:length(protein.exp), site]
rownames(dri2.exp) = protein.exp

```

[//]: Prepare data for no selection (mut)

```{r read_and_set_data_mut}
# read simulated data
dri2.mut = read.csv(dri2.mut.fname, header = T)
site = site.info$site
dri2.mut = dri2.mut[1:length(protein.exp), site]
rownames(dri2.mut) = paste("mut", rownames(dri2.mut), sep = "")

```

[//]: Prepare data for strong selection

```{r read_and_set_data_strong}
# read simulated data
dri2.strong = read.csv(dri2.strong.fname, header = T)
site = site.info$site
dri2.strong = dri2.strong[1:length(protein.exp), site]
rownames(dri2.strong) = paste("strong", rownames(dri2.strong), sep = "")

```

# Structural divergence along sites

Here we study how structural divergence varies from site to site. We will compare simulated data and empirical data. 


```{r prepare_site_data}
# prepare my data.frame

tdri2.strong = as.data.frame(t(as.matrix(dri2.strong)))
tdri2.strong = cbind(site.info, tdri2.strong)
siteComparison.strong = melt(tdri2.strong, id.vars = names(site.info), variable.name = "protein", value.name = "dri2")

tdri2.mut = as.data.frame(t(as.matrix(dri2.mut)))
tdri2.mut = cbind(site.info, tdri2.mut)
siteComparison.mut = melt(tdri2.mut, id.vars = names(site.info), variable.name = "protein", value.name = "dri2")

tdri2.exp = as.data.frame(t(as.matrix(dri2.exp)))
tdri2.exp = cbind(site.info, tdri2.exp)
siteComparison.exp = melt(tdri2.exp, id.vars = names(site.info), variable.name = "protein", value.name = "dri2")

siteComparison.all.datasets = rbind(
  data.frame("dataset" = "exp", siteComparison.exp),
  data.frame("dataset" = "mut", siteComparison.mut),
  data.frame("dataset" = "strong", siteComparison.strong))

siteComparison.all.datasets = ddply(siteComparison.all.datasets, c("dataset", "protein"), mutate,
          "n.SD" = dri2/mean(dri2, na.rm = T),
          "z.SD" = vscale(dri2),
          "RSD" = sqrt(dri2), 
          "n.RSD" = RSD/mean(RSD, na.rm = T),
          "z.RSD" = vscale(RSD))
```

### Mean z.RSD vs site

To measure structural divergence we use z.RSD profiles, which are the best, at least for globins (most similar distributions and profiles w.r.t experimental).

The following plot compares the mean z.RSD profiles, including standard errors (with .999 confidence level for the mean)
*Warning: the effective number of data should be smaller than the actual data, especially for the experimental dataset because of several factors, including smoothing of the profiles, phylogenetic relationships, etc. We need to deal with this for quantitative analysis. Probably we'll need to use bootstrapping to calculate standard errors non-parametrically*

```{r mean_z_RSD_vs_site}
# comparison of z.RSD profiles with functional sites

## prepare dat
dat = siteComparison.all.datasets
dat$dataset = revalue(dat$dataset, c("strong" = "mut+sel"))

## dat with means and standard errors
d = ddply(dat,c("dataset","site","AA","shell"), function(x) {
                mean.z.RSD = mean(x$z.RSD, na.rm = T)
                ndata = sum(!is.na(x$z.RSD))
                se.z.RSD = sd(x$z.RSD, na.rm = T) / sqrt(ndata)
                data.frame(mean.z.RSD, ndata, se.z.RSD)
})

## comparison of means with the minimum distance to the functional sites
z.RSD.exp = d$mean.z.RSD[d$dataset == "exp"]
z.RSD.strong = d$mean.z.RSD[d$dataset == "mut+sel"]
z.RSD.mut = d$mean.z.RSD[d$dataset == "mut"]

plot(y = z.RSD.exp - z.RSD.mut, x = m.min.da.CM.ca$min.da.ca, xlab = "minimal distance to active site (between CAs)")
plot(y = z.RSD.exp - z.RSD.mut, x = m.min.da.CM.ca$min.da.CM, xlab = "minimal distance to active site (between CMs)")

r.min.da.CA = cor((z.RSD.exp - z.RSD.mut), m.min.da.CM.ca$min.da.ca)
r.min.da.CM = cor((z.RSD.exp - z.RSD.mut), m.min.da.CM.ca$min.da.CM)

cor.df = data.frame("comparison" = c("(exp - mut) vs min.da.CA", "(exp - mut) vs min.da.CM"),
                    "R" = c(r.min.da.CA, r.min.da.CM)) 
knitr::kable(cor.df, digits = 2)

## find active sites
d$label = as.character(d$site)
active.sites = d$site[d$shell == 0]

## start with a print of smoothed profiles
plot(smooth(z.RSD.exp), col = "blue", type = "l")
lines(smooth(z.RSD.strong), col = "red")
lines(smooth(z.RSD.mut), col = "green")
abline(v = active.sites, col = "grey")

## plot mean profiles with deviations
p = ggplot(d,aes(x = site, y = mean.z.RSD, col = dataset, fill = dataset)) +
    geom_line() +
    geom_ribbon(aes(ymin = mean.z.RSD - f95 * se.z.RSD, ymax = mean.z.RSD + se.z.RSD), alpha = .4, show.legend = F) +
    geom_vline(xintercept = active.sites, col = "grey", show.legend = F) +
    labs(x = "site", y = "structural divergence(mean z.RSD)") +
    coord_cartesian(ylim = c(-1.5, 2.8)) +
    scale_colour_manual(name = NULL, values = myColors) + 
    scale_fill_manual(name = NULL, values = myColors)

## plot separate and comparative plots
p.facet = p + facet_grid(dataset~., switch = "y") + theme(legend.position = "none")

p.facet %+% subset(d, dataset == "exp") 
p.facet %+% subset(d, dataset == "mut")
p.facet %+% subset(d, dataset == "mut+sel") 
p.facet

## p + theme(legend.position = "bottom", legend.title = element_blank())
p + theme(legend.position = "bottom")

```

```{r mean-n-RSD-vs-site}
# comparison of n.RSD profiles with functional sites

## prepare dat
dat = siteComparison.all.datasets
dat$dataset = revalue(dat$dataset, c("strong" = "mut+sel"))

## dat with means and standard errors
d = ddply(dat,c("dataset","site","AA","shell"), function(x) {
                mean.n.RSD = mean(x$n.RSD, na.rm = T)
                ndata = sum(!is.na(x$n.RSD))
                se.n.RSD = sd(x$n.RSD, na.rm = T) / sqrt(ndata)
                data.frame(mean.n.RSD, ndata, se.n.RSD)
})

## comparison of means with the minimum distance to the functional sites
n.RSD.exp = d$mean.n.RSD[d$dataset == "exp"]
n.RSD.strong = d$mean.n.RSD[d$dataset == "mut+sel"]
n.RSD.mut = d$mean.n.RSD[d$dataset == "mut"]

plot(y = n.RSD.exp - n.RSD.mut, x = m.min.da.CM.ca$min.da.ca, xlab = "minimal distance to active site (between CAs)")
plot(y = n.RSD.exp - n.RSD.mut, x = m.min.da.CM.ca$min.da.CM, xlab = "minimal distance to active site (between CMs)")

r.min.da.CA = cor((n.RSD.exp - n.RSD.mut), m.min.da.CM.ca$min.da.ca)
r.min.da.CM = cor((n.RSD.exp - n.RSD.mut), m.min.da.CM.ca$min.da.CM)

cor.df = data.frame("comparison" = c("(exp - mut) vs min.da.CA", "(exp - mut) vs min.da.CM"),
                    "R" = c(r.min.da.CA, r.min.da.CM)) 
knitr::kable(cor.df, digits = 2)

## start with a print of smoothed profiles
plot(smooth(n.RSD.exp), col = "blue", type = "l")
lines(smooth(n.RSD.strong), col = "red")
lines(smooth(n.RSD.mut), col = "green")
abline(v = active.sites)

## plot mean profiles with deviations
p = ggplot(d,aes(x = site, y = mean.n.RSD, col = dataset, fill = dataset)) +
    geom_line() +
    geom_ribbon(aes(ymin = mean.n.RSD - f95 * se.n.RSD, ymax = mean.n.RSD + se.n.RSD), alpha = .4, show.legend = F) +
    geom_vline(xintercept = active.sites, col = "grey", show.legend = F) +
    labs(x = "site", y = "structural divergence(mean n.RSD)") +
    coord_cartesian(ylim = c(-1.5, 2.8)) +
    scale_colour_manual(name = NULL, values = myColors) + 
    scale_fill_manual(name = NULL, values = myColors)

## plot separate and comparative plots
p.facet = p + facet_grid(dataset~., switch = "y") + theme(legend.position = "none")

p.facet %+% subset(d, dataset == "exp") 
p.facet %+% subset(d, dataset == "mut")
p.facet %+% subset(d, dataset == "mut+sel") 
p.facet

## p + theme(legend.position = "bottom", legend.title = element_blank())
p + theme(legend.position = "bottom")

```

### Correlation between site profiles

```{r}
# z-score
dat = siteComparison.all.datasets

## dat with means and standard errors
dat = ddply(dat,c("dataset", "site", "AA", "shell"), function(x) {
                mean.z.RSD = mean(x$z.RSD, na.rm = T)
                ndata = sum(!is.na(x$z.RSD))
                se.z.RSD = sd(x$z.RSD, na.rm = T) / sqrt(ndata)
                data.frame(mean.z.RSD, ndata, se.z.RSD)
})

dat.exp = subset(dat, dataset == "exp")
dat.mut = subset(dat, dataset == "mut")
dat.strong = subset(dat, dataset == "strong")

ggplot(dat, aes(x = site, y = mean.z.RSD, col = dataset)) + geom_line() +
    geom_text(data = subset(dat, dataset == "exp" & mean.z.RSD < -.5), aes(x = site, y = mean.z.RSD, label = site), nudge_y = -.1, size = 1.8)+
    geom_vline(xintercept = active.sites, col = "grey", show.legend = F)

## calculate correlations
r.exp.mut = cor(dat.exp$mean.z.RSD, dat.mut$mean.z.RSD)
r.exp.strong = cor(dat.exp$mean.z.RSD, dat.strong$mean.z.RSD)
r.mut.strong = cor(dat.mut$mean.z.RSD, dat.strong$mean.z.RSD)
cor.df = data.frame("comparison" = c("exp vs mut", "exp vs strong", "mut vs strong"),
                    "R" = c(r.exp.mut, r.exp.strong, r.mut.strong))
knitr::kable(cor.df, digits = 2)

# norm
dat = siteComparison.all.datasets

## dat with means and standard errors
dat = ddply(dat,c("dataset", "site", "AA", "shell"), function(x) {
                mean.n.RSD = mean(x$n.RSD, na.rm = T)
                ndata = sum(!is.na(x$n.RSD))
                se.n.RSD = sd(x$n.RSD, na.rm = T) / sqrt(ndata)
                data.frame(mean.n.RSD, ndata, se.n.RSD)
})

dat.exp = subset(dat, dataset == "exp")
dat.mut = subset(dat, dataset == "mut")
dat.strong = subset(dat, dataset == "strong")

ggplot(dat, aes(x = site, y = mean.n.RSD, col = dataset)) + geom_line() +
    geom_text(data = subset(dat, dataset == "exp" & mean.n.RSD < -.5), aes(x = site, y = mean.n.RSD, label = site), nudge_y = -.1, size = 1.8)+
    geom_vline(xintercept = active.sites, col = "grey", show.legend = F)

## calculate correlations
r.exp.mut = cor(dat.exp$mean.n.RSD, dat.mut$mean.n.RSD)
r.exp.strong = cor(dat.exp$mean.n.RSD, dat.strong$mean.n.RSD)
r.mut.strong = cor(dat.mut$mean.n.RSD, dat.strong$mean.n.RSD)
cor.df = data.frame("comparison" = c("exp vs mut", "exp vs strong", "mut vs strong"),
                    "R" = c(r.exp.mut, r.exp.strong, r.mut.strong))
knitr::kable(cor.df, digits = 2)
```

