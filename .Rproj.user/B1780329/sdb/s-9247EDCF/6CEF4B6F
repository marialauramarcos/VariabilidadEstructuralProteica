{
    "contents" : "# This function generates mutants of a given protein using two possible models:\n# - \"LFENM\" (Linearly Forced - Elastic Network Model), considering additive single mutations.\n# - \"MND\" (Multivariate Normal Distribution), considering mu = dr expected value = 0 and Sigma = Cov.\n#\n#  Args:\n#    family: the family of the protein to mutate.\n#    exp.chain.p.ref: the chain of p.ref in the pdb file obtained from Homstrad.\n#    mut.model: mutational model. It can be \"LFENM\" or \"MND\".\n#    n.mut.p: the number of mutants to generate for each protein of the family.\n#    fmax: argument for \"LFENM\". It is the maximun value for the forces that model the mutations.\n#    R0: the cut-off for the ANM (\"Anisotropic Network Model\").\n#    heme: argument for \"globins\". It can be \"TRUE\" or \"FALSE\". If it is \"TRUE\" the program considers the heme group.\n#    natural.selection: It can be \"TRUE\" or \"FALSE\". If it is \"TRUE\", the mutants are calculated considering natural \n#    selection. If it is \"FALSE\", the mutants are calculated in a random manner.\n#    data.dir: directory of the data.It must contain the output of the function AnalyzeFamily().\n#    out.dir: output directory.\n#    mut.fname.id: ID for output filenames.\n#    TOLERANCE: 0 tolerance.\n#\n#  Requires:\n#    ReadCA\n#    ReadHeme\n#    CalculateENMK\n#    CalculateForce\n#\n#  Returns:\n#    File with a vector of coordinates of p.ref in out.dir.\n#    File with a matrix of coordinates of the mutants in each column in out.dir.\n\nGenerateMutants <- function(family,\n                            exp.chain.p.ref,\n                            mut.model,\n                            n.mut.p,\n                            fmax, \n                            R0,\n                            heme,\n                            natural.selection,\n                            data.dir,\n                            out.dir,\n                            mut.fname.id,\n                            TOLERANCE) {\n\n  # Filenames.\n  pdbs.fname <- file.path(data.dir, paste(family, \"_coordinates.pdb\", sep = \"\")) \n  m.aligned.mut.p.ref.index.fname <- file.path(out.dir, paste(family, \"_out_m.aligned.mut.p.ref.index.csv\", sep = \"\"))\n  m.not.aligned.p.ref.index.fname <- file.path(out.dir, paste(family, \"_out_m.not.aligned.p.ref.index.csv\", sep = \"\"))\n  m.identity.fname <- file.path(out.dir, paste(family, \"_out_m.identity.csv\", sep = \"\"))\n  \n  # Read PDB of p.ref.\n  pdb = ReadCA(pdbs.fname, exp.chain.p.ref)\n  r.p.ref = pdb$xyz.calpha\n  n.aa = pdb$n.sites\n  \n  # Calculate heme coordinates, add them to CAÂ´s coordinates and calculate the number of sites.\n  if (heme == \"TRUE\") {\n    r.heme = ReadHeme(pdbs.fname, exp.chain.p.ref)\n    r.p.ref = cbind(r.p.ref, r.heme)\n    n.sites = ncol(r.p.ref)\n  } else {\n    n.sites = n.aa\n  }\n\n  # Calculate K of p.ref.\n  ENMK.p.ref = CalculateENMK(r.p.ref, CalculateKij, R0, TOLERANCE)\n  \n  # Get mutated and not aligned sites of p.ref in the multiple alignment, the % sequence identity between p.ref\n  # and the other proteins, and the number of proteins.\n  m.aligned.mut.p.ref.index = read.csv(m.aligned.mut.p.ref.index.fname)\n  m.not.aligned.p.ref.index = read.csv(m.not.aligned.p.ref.index.fname)\n  m.identity = read.csv(m.identity.fname)$V1\n  n.prot = nrow(m.aligned.mut.p.ref.index)\n\n  # Calculate mutants using \"LF-ENM\".\n  if (mut.model == \"LFENM\") {\n\n    # Create a matrix to save coordinates of each generated mutant.\n    m.r.mut = matrix(nrow = 3 * n.sites, ncol = n.prot * n.mut.p)\n\n    # Start a loop to read mutated sites of p.ref for each P.\n    for (P in (1:n.prot)) {\n      \n      # Get mutated and not aligned sites of p.ref for each P (natural.selection == TRUE).\n      if (natural.selection == \"TRUE\") {\n        aligned.mut.p.ref.index = m.aligned.mut.p.ref.index[P, ]\n        not.aligned.p.ref.index = m.not.aligned.p.ref.index[P, ]\n    \n        aligned.mut.p.ref.index = as.numeric(aligned.mut.p.ref.index[, !is.na(aligned.mut.p.ref.index)])\n        not.aligned.p.ref.index = as.numeric(not.aligned.p.ref.index[, !is.na(not.aligned.p.ref.index)])\n      \n        mutated.index = c(aligned.mut.p.ref.index, not.aligned.p.ref.index)\n      }\n      \n      # Start a loop to generate n.mut.p mutants for each P.\n      for(mut in seq(n.mut.p)) {\n        print(c(P, mut))\n        \n        # Get mutated sites of p.ref for each P (natural.selection == FALSE).\n        if (natural.selection == \"FALSE\") {\n          n.sites.mut = (100 - mean(m.identity)) * n.aa / 100\n          mutated.index = sample(1:n.aa, replace = F)[1:n.sites.mut]\n        }\n        \n        # Calculate forces.\n        f = rep(0, 3 * n.sites)\n        for (l in as.numeric(mutated.index)) {\n          fl = CalculateForce(l, r.p.ref, ENMK.p.ref$kij, fmax)\n          f = f + fl\n        }\n        \n        # Calculate dr and r.mut.\n        dr.mut = ENMK.p.ref$cov %*% f\n        r.mut = as.vector(r.p.ref) + dr.mut\n       \n        # Keep r.mut.\n        m.r.mut[, n.mut.p * P - (n.mut.p - mut)] = r.mut\n       }\n     }\n   }\n  \n  # Calculate mutants using \"MND\".\n  if (mut.model == \"MND\") {\n    \n    # Calculate the expected dr value for each site.\n    dr = matrix(0, nrow = 1, ncol = 3 * n.sites)\n  \n    # Create a matrix to save coordinates of each mutant.\n    m.r.mut = matrix(0, nrow = 3 * n.sites, ncol = n.prot * n.mut.p)\n  \n    # Start a loop to calculate coordinates of the mutants.\n    for (mut in seq(n.prot * n.mut.p)) {\n      print(mut)\n      \n      # Calculate dr and r.mut.\n      dr.mut =  mvrnorm(n = 1, dr, ENMK.p.ref$cov)\n      r.mut =  as.vector(r.p.ref) + dr.mut\n      \n      # Keep r.mut.\n      m.r.mut[, mut] = r.mut\n    }\n  }\n  \n  # Create files and save the data.\n  write.csv(as.vector(r.p.ref), file = file.path(out.dir, paste(mut.fname.id, \"_out_r.p.ref.csv\", sep = \"\")), row.names = FALSE)\n  write.csv(m.r.mut, file = file.path(out.dir, paste(mut.fname.id, \"_out_m.r.mut.csv\", sep = \"\")), row.names = FALSE)\n}\n  \n  \n",
    "created" : 1457446250966.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2854632562",
    "id" : "6CEF4B6F",
    "lastKnownWriteTime" : 1456617454,
    "path" : "C:/Users/Laurita/Desktop/Doctorado/VariabilidadEstructuralProteica/FUNCTIONS/GenerateMutants.R",
    "project_path" : "FUNCTIONS/GenerateMutants.R",
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "type" : "r_source"
}