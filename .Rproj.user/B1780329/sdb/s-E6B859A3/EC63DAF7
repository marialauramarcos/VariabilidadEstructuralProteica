{
    "contents" : "# INFORMACIÓN:\n#\n# El programa genera mutantes múltiples de una proteína determinada usando el modelo mutacional Linearly \n# Forced - Elastic Network Model (LF-ENM) y considerando a las fuerzas que modelan cada mutación aditivas \n# entre sí. Además, calcula medidas de variabilidad estructural y dinámica entre las proteínas mutantes \n# generadas y la proteína de referencia.\n#\n# Para utilizar el programa se debe completar un input (\"DATA/Theoretical/theoretical_input.csv\") especificando: \n# -family: la familia de proteínas a la que pertenece la proteína a mutar. \n# Tener en cuenta que las familias que pueden ser analizadas experimentalmente son\n# \"serinProteases\", \"globins\" o \"plastocyanins\".\n# -p.ref: el código de pdb (pdbid) de la proteína a mutar (ej.:\"1a6m\")\n# -chain: la cadena de p.ref que se desea mutar.\n# -heme: solo se utiliza para la familia de las globinas, puede ser \"TRUE\" o \"FALSE\" dependiendo de \n# si se quiere considerar o no al grupo HEMO. \n# -nmut: la cantidad de mutantes a generar.\n# -nsitesmut: la cantidad de sitios mutados por proteína mutante.\n# -Fmax: valor máximo de las fuerzas usadas para la simulación de las mutaciones.\n# -model: el modelo de red elástica a usar, que solo puede ser \"ANM\" por el momento.\n# -R0: cut-off del ANM.\n# -core: puede ser \"TRUE\" o \"FALSE\" dependiendo de si se quiere analizar solo los sectores\n# del alineamiento donde no hay gaps. \n\n# Remove objects.\nrm(list = ls())\n\n# Data dir.\ndata.dir <- \"DATA/Theoretical\"\n\n# Read input.\ninput.fname <- file.path(data.dir, \"theoretical_input.csv\")\ninput <- read.csv(input.fname)\nfamily <- input$family\np.ref <- input$p.ref \nchain <- input$chain\nheme <- input$heme \nnmut = input$nmut \nnsitesmut = input$nsitesmut \nfmax = input$fmax \nmodel <- input$model\nR0 = input$R0\ncore = input$core\n\n# PDB fname.\npdb.fname <- file.path(data.dir, paste(p.ref, \".pdb\", sep = \"\"))\n\n# Alignment fname.\nalignment.fname <- file.path(data.dir, paste(family, \"_alignment.txt\", sep = \"\")) \n\n# Functions fnames.\nReadCA.fname <- \"FUNCTIONS/ReadCA.R\" \nReadHeme.fname <- \"FUNCTIONS/ReadHeme.R\"\nAnalyzeAlignmentGeneral.fname <- \"FUNCTIONS/AnalyzeAlignmentGeneral.R\" \nCalculateKij.fname <- file.path(\"FUNCTIONS\", paste(\"CalculateKij\", model, \".R\", sep = \"\")) \nCalculateK.fname <- \"FUNCTIONS/CalculateK.R\" \nCalculateKeff.fname <- \"FUNCTIONS/CalculateKeff.R\"  \nCalculateForce.fname <- \"FUNCTIONS/CalculateForce.R\"  \nCalculateVariability.fname <- \"FUNCTIONS/CalculateVariability.R\"\n\n# Output dir.\nout.dir <- \"OUT/Theoretical\"\n\n# General parameters.\nTOLERANCE = 1e-10\n\n# Load librarys.\nlibrary(bio3d)\n\n# Source functions.\nsource(ReadCA.fname)\nsource(ReadHeme.fname)\nsource(AnalyzeAlignmentGeneral.fname)\nsource(CalculateKij.fname)\nsource(CalculateK.fname)\nsource(CalculateKeff.fname)\nsource(CalculateForce.fname)\nsource(CalculateVariability.fname)\n\n# Read PDB of p.ref.\nget.pdb(as.character(p.ref), data.dir) \npdb <- ReadCA(pdb.fname, chain)\nr.p.ref = pdb$xyz.calpha\nnaa = pdb$nsites\n\nif (core == \"TRUE\") {\n  # Read alignment.\n  alignment.id <- read.fasta(alignment.fname)\n  alignment <- alignment.id$ali[, -ncol(alignment.id$ali)]  # The last column is \"*\".\n  id <- alignment.id$id\n\n  # Create a data frame to analyze the alignment.\n  df.alignment <- list(\"alignment\" = alignment,\n                              \"id\" = id,   \n                             \"p.1\" = p.ref,\n                             \"p.2\" = p.ref)\n  class(df.alignment) <- \"Core\"\n  \n  # Anylize alignment.\n  a.alignment <- AnalyzeAlignmentGeneral(df.alignment)\n  aligned.index = a.alignment$aligned.p.1.index\n  not.aligned.index = a.alignment$not.aligned.p.1.index\n  naligned = a.alignment$naligned\n} else {  \n  \n  # Aligned indexes for core = FALSE.\n  aligned.index = seq(1:naa)\n  not.aligned.index = c()\n  naligned = naa\n} \n\nif (family == \"globins\" & heme == \"TRUE\") {\n  \n  # Calculate r.heme and add to r.p.ref and to not.aligned.index.\n  r.heme = ReadHeme(pdb.fname, chain)\n  r.p.ref = cbind(r.p.ref, r.heme)\n  nsites = ncol(r.p.ref)\n  not.aligned.index = c(not.aligned.index, seq((naa + 1), nsites))\n} else {\n  \n  # nsites for heme = FALSE.\n  nsites = naa\n}\n\n# Calculate K of p.ref.\nK.p.ref <- CalculateK(r.p.ref, CalculateKij, R0, TOLERANCE)\n\n# Measures of variability.\nm.nH = matrix(ncol = 3 * naligned, nrow = nmut)\nm.Pn = matrix(ncol = 3 * naligned, nrow = nmut)\nm.d.evalues = matrix(ncol = 3 * naligned, nrow = nmut)\nm.dr.squarei = matrix(ncol = naligned, nrow = nmut)\n\n# Count the number of mutants to discard.\ncount = 0\n\n# Calculate mutants.\nfor(mut in seq(nmut)) {\n  f <- rep(0, 3 * nsites)\n  for (l in (sample(1:naa, replace = F)[1:nsitesmut])) {\n    print(c(mut, l))\n    fl = CalculateForce(l, r.p.ref, K.p.ref$kij, fmax)\n    f = f + fl\n  }\n  dr = K.p.ref$cov %*% f\n  dim(dr) <- c(3, nsites)\n  r.mut = r.p.ref + dr\n  \n  # Rotate mutants minimizing RMSD with P.ref.\n  aligned.index3N = c(aligned.index * 3,\n                      aligned.index * 3 - 2,\n                      aligned.index * 3 - 1)\n  r.mut <- matrix(fit.xyz(fixed = as.vector(r.p.ref), \n                         mobile = as.vector(r.mut),\n                     fixed.inds = aligned.index3N,\n                    mobile.inds = aligned.index3N), nrow = 3) \n  \n  # Calculate dr.\n  dr = (r.mut - r.p.ref)[, aligned.index]\n  \n  # Calculate K of p.ref and p.mut.\n  K.p.ref.2 <- CalculateKeff(r.p.ref,\n                             aligned.index, \n                             not.aligned.index,\n                             CalculateK, \n                             CalculateKij, \n                             R0,\n                             TOLERANCE)\n  \n  K.mut <- CalculateKeff(r.mut, \n                         aligned.index, \n                         not.aligned.index,\n                         CalculateK, \n                         CalculateKij, \n                         R0, \n                         TOLERANCE)\n  \n  # Calculate nmodes.\n  nmodes.p.ref.2 <- length(K.p.ref.2$va)\n  nmodes.mut <- length(K.mut$va)\n\n  # Calculate measures o variability.\n  if (nmodes.p.ref.2 == nmodes.mut) {\n    VA <- CalculateVariability(dr, K.p.ref.2, K.mut)\n    m.nH[mut, 1:nmodes.p.ref.2] = t(VA$nH)\n    m.Pn[mut, 1:nmodes.p.ref.2] = t(VA$Pn)\n    m.d.evalues[mut, 1:nmodes.p.ref.2] = t(VA$d.evalues[1:nmodes.p.ref.2])\n    dr.squarei = rbind(VA$dr.squarei, aligned.index)\n    for (i in (1:naligned)) {\n      m.dr.squarei[mut, i] = matrix(dr.squarei[1, dr.squarei[2, ] == i], ncol = 1, nrow = 1)\n    }\n  }\n  if (nmodes.p.ref.2 != nmodes.mut) { \n    count <- count +1\n  }\n}\n\n# Calculate Means.\nmean.nH = colMeans(m.nH, na.rm = T)\nmean.Pn = colMeans(m.Pn, na.rm = T)\nmean.d.evalues = colMeans(m.d.evalues, na.rm = T)\nMSDi = colMeans(m.dr.squarei, na.rm = T)\nMSD = rowMeans(m.dr.squarei, na.rm = T)\n\n# Save information.\nif (family == \"globins\") {\n  family <- paste(family, \"_heme_\", heme, sep = \"\")\n}\nwrite.csv(m.nH, file = file.path(out.dir, paste(family, \"_core_\", core, \"_out_m.nH.csv\", sep = \"\")), row.names = FALSE)\nwrite.csv(m.Pn, file = file.path(out.dir, paste(family, \"_core_\", core, \"_out_m.Pn.csv\", sep = \"\")), row.names = FALSE)\nwrite.csv(m.d.evalues, file = file.path(out.dir, paste(family, \"_core_\", core, \"_out_m.d.evalues.csv\", sep = \"\")), row.names = FALSE)\nwrite.csv(m.dr.squarei, file = file.path(out.dir, paste(family, \"_core_\", core, \"_out_m.dr.squarei.csv\", sep = \"\")), row.names = FALSE)\nwrite.csv(K.p.ref.2$va, file = file.path(out.dir, paste(family, \"_core_\", core, \"_out_evalues.csv\", sep = \"\")), row.names = FALSE)\n\nwrite.csv(mean.nH, file = file.path(out.dir, paste(family, \"_core_\", core, \"_out_nH.mean.csv\", sep = \"\")), row.names = FALSE)\nwrite.csv(mean.Pn, file = file.path(out.dir, paste(family, \"_core_\", core, \"_out_Pn.mean.csv\", sep = \"\")), row.names = FALSE)\nwrite.csv(mean.d.evalues, file = file.path(out.dir, paste(family, \"_core_\", core, \"_out_d.evalues.mean.csv\", sep = \"\")), row.names = FALSE)\nwrite.csv(MSDi, file = file.path(out.dir, paste(family, \"_core_\", core, \"_out_MSDi.csv\", sep = \"\")), row.names = FALSE)\nwrite.csv(MSD, file = file.path(out.dir, paste(family, \"_core_\", core, \"_out_MSD.csv\", sep = \"\")), row.names = FALSE)\nwrite.csv(input, file = file.path(out.dir, paste(family, \"_core_\", core, \"_input\", sep = \"\")), row.names = FALSE)\n",
    "created" : 1448041990492.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1822447473",
    "id" : "EC63DAF7",
    "lastKnownWriteTime" : 1447683379,
    "path" : "C:/Users/Laurita/Desktop/Doctorado/VariabilidadEstructuralProteica/TheoreticalMain.R",
    "project_path" : "TheoreticalMain.R",
    "properties" : {
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "type" : "r_source"
}