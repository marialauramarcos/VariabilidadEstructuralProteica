---
title: "Dynamical Divergence Analysis"
author: "Maria Laura Marcos, Julian Echave"
output: html_document
---

# Introduction
We study the evolutionary divergence of proteins using the LF-ENM and comparing simulated mutants with experimental data.

```{r setup, include = FALSE}
# set chunk options
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```
```{r load-packages}
# load packages
library(ggplot2)
library(reshape2)
library(plyr)
library(quantreg)
library(bio3d)

# load functions
source(file.path(data.dir, "multiplot.R"))
source(file.path(data.dir, "my-functions.R")) 
```

```{r set-my-colors}
# set my colors
myColors = c("blue", "darkgreen","darkgreen", "red", "red", "red") 
names(myColors) <- c("exp", "mut", "no-selection", "medium", "selection", "mut+sel")
```

```{r set-run-variables}
# general parameters
tolerance = 1e-10

# set significance factors
f95 = 1.96
f99 = 2.6
f999 = 3.3
```

```{r set-file-names}
# set input filenames
## data
reference.fname = file.path(data.dir, paste(family, "_ref.txt", sep = ""))
protein_list.fname = file.path(data.dir, paste(family, "_list.txt", sep = ""))
site.info.fname = file.path(data.dir, paste(p.ref, "_m.da.ca.csv", sep = ""))
min.da.CM.CA.fname = file.path(data.dir, paste(p.ref, "_min.da.CM.ca.csv", sep = ""))

## profiles to compare
### square.dif.MSF
square.dif.MSF.exp.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.exp.square.dif.MSF.csv", sep = ""))
square.dif.MSF.medium.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_medium.sel_K.analysis_Keff_out_m.theo.square.dif.MSF.csv", sep = ""))
square.dif.MSF.mut.fname = file.path(data.dir,paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.theo.square.dif.MSF.csv", sep = ""))

### dri2
dri2.exp.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.exp.norm.dr.squarei.csv", sep = ""))
dri2.medium.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_medium.sel_K.analysis_Keff_out_m.theo.norm.dr.squarei.csv", sep = ""))
dri2.mut.fname = file.path(data.dir,paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.theo.norm.dr.squarei.csv", sep = ""))

```
```{r set-reference-protein}
# which is the reference protein?
reference = as.character(read.table(reference.fname, header = F)[1, 1])
if (reference != p.ref) {
  print("Warning: different references")
}
```
We studied the `r family` family. 
We used the ENM `r enm` with R0 = `r R0` to generate mutants.
We used as reference for the ENM the protein with pdb code `r reference`. 
We simulated `r n.mut.p` mutants of this reference for each protein of the family.
The `r family` family is of the type `r type` and consists of the following proteins:

```{r set-experimental-protein-names, comment = ""}
# experimental protein names
protein.exp = read.table(protein_list.fname, header = F, stringsAsFactors = F)[, 1]
protein.exp = protein.exp[protein.exp != reference]
print(protein.exp)
```

```{r set-site-info}
# read site information of the reference protein
site.info = read.csv(site.info.fname, header = T, sep = ",")

# add info to site.info
d = ddply(site.info, "site", .fun = function(x) data.frame("da" = min(x[, c(-1, -2)])))

# define shells of active.sites site neighborhood
d$shell = cut(d$da, breaks = c(-.1, 2.5, 7.5, 12.5, 17.5, 22.5, 27.5, 32.5, 37.5, 42.5, 47.5, 52.5, max(d$da)))
levels(d$shell) = seq(length(levels(d$shell))) - 1 # rename shell levels
site.info = merge(site.info, d, by = "site")

# read reference pdb and calculate resno, AA, and CN
reference.pdb.fname = file.path(data.dir,paste(reference, ".pdb", sep = ""))
ref.pdb = read.pdb(reference.pdb.fname)
inds = atom.select(ref.pdb, elety = "CA")
ref.pdb.ca = ref.pdb$atom[inds$atom,]
cmap.ca = cmap(ref.pdb$xyz[inds$xyz], dcut = R0, scut = 0, mask.lower = F)
r.p.ref = ref.pdb$xyz[inds$xyz]
CN = rowSums(cmap.ca, na.rm = T) - 1 # diag(cmap.ca) returned by cmap is 1!
n.sites = length(CN)
AA = ref.pdb.ca$resid
resno = ref.pdb.ca$resno
pdb.info = data.frame(resno, AA, CN)
names(pdb.info) = c("resno", "AA", paste("CN", as.character(R0), sep = ""))

# add pdb.info to site.info
site.info = cbind(site.info, pdb.info)
```

```{r read-site-data}
# read MSF data
square.dif.MSF.exp = read.csv(square.dif.MSF.exp.fname, header = T)
square.dif.MSF.mut = read.csv(square.dif.MSF.mut.fname, header = T)
square.dif.MSF.medium = read.csv(square.dif.MSF.medium.fname, header = T)

# read dri2 data
dri2.exp = read.csv(dri2.exp.fname, header = T)
dri2.mut = read.csv(dri2.mut.fname, header = T)
dri2.medium = read.csv(dri2.medium.fname, header = T)
```

```{r MSF-p.ref}
# calculate MSF (Mean Square Fluctuation)

## calculate ENM
ENMK.p.ref = CalculateENMKeff(matrix(r.p.ref, nrow = 3), 
                              seq(1:n.sites), 
                              c(), 
                              R0, 
                              tolerance, 
                              K.analysis)
## get cov matrix
cov.p.ref = ENMK.p.ref$cov

## get the diagonal of the cov matrix
diag.p.ref = diag(cov.p.ref)

## calculate the factor to split the diagonal
factor = sort(rep(seq(1:n.sites), 3))

## split the diagonal
s.diag.p.ref = split(diag.p.ref, factor)

## create a matrix to save the data
MSF.p.ref = matrix(nrow = 1, ncol = n.sites)

## start a loop to calculate sums for each site
for (i in (1:n.sites)) {
  MSF.p.ref[, i] = sum(unlist(s.diag.p.ref[i]), use.names = F)
}
 
```

```{r prepare-site-data-MSF}
# prepare the data
## exp
tsquare.dif.MSF.exp = as.data.frame(t(as.matrix(square.dif.MSF.exp)))
tsquare.dif.MSF.exp = cbind(site.info, tsquare.dif.MSF.exp)
siteComparison.exp = melt(tsquare.dif.MSF.exp, id.vars = names(site.info), variable.name = "protein", value.name = "square.dif.MSF")

## mut
tsquare.dif.MSF.mut = as.data.frame(t(as.matrix(square.dif.MSF.mut)))
tsquare.dif.MSF.mut = cbind(site.info, tsquare.dif.MSF.mut)
siteComparison.mut = melt(tsquare.dif.MSF.mut, id.vars = names(site.info), variable.name = "protein", value.name = "square.dif.MSF")

## medium
tsquare.dif.MSF.medium = as.data.frame(t(as.matrix(square.dif.MSF.medium)))
tsquare.dif.MSF.medium = cbind(site.info, tsquare.dif.MSF.medium)
siteComparison.medium = melt(tsquare.dif.MSF.medium, id.vars = names(site.info), variable.name = "protein", value.name = "square.dif.MSF")

# bluild the data.frame
siteComparison.all.datasets = rbind(data.frame("dataset" = "exp", siteComparison.exp),
                                    data.frame("dataset" = "mut", siteComparison.mut),
                                    data.frame("dataset" = "medium", siteComparison.medium))

siteComparison.all.datasets = ddply(siteComparison.all.datasets, c("dataset", "protein"), mutate,
          "r.SDF" = rank(square.dif.MSF, na.last = "keep")) 
```

```{r prepare-site-data-dri2}
# prepare the data
## exp
tdri2.exp = as.data.frame(t(as.matrix(dri2.exp)))
tdri2.exp = cbind(site.info, tdri2.exp)
siteComparison.exp = melt(tdri2.exp, id.vars = names(site.info), variable.name = "protein", value.name = "dri2")

## mut
tdri2.mut = as.data.frame(t(as.matrix(dri2.mut)))
tdri2.mut = cbind(site.info, tdri2.mut)
siteComparison.mut = melt(tdri2.mut, id.vars = names(site.info), variable.name = "protein", value.name = "dri2")

## medium
tdri2.medium = as.data.frame(t(as.matrix(dri2.medium)))
tdri2.medium = cbind(site.info, tdri2.medium)
siteComparison.medium = melt(tdri2.medium, id.vars = names(site.info), variable.name = "protein", value.name = "dri2")

# bluild the data.frame
siteComparison.all.datasets.dri2 = rbind(data.frame("dataset" = "exp", siteComparison.exp),
                                         data.frame("dataset" = "mut", siteComparison.mut),
                                         data.frame("dataset" = "medium", siteComparison.medium))

siteComparison.all.datasets.dri2 = ddply(siteComparison.all.datasets.dri2, c("dataset", "protein"), mutate,
          "RSD" = sqrt(dri2), 
        "z.RSD" = vscale(RSD))
```

### Dynamical divergence along sites

In this section we consider dynamical divergence along Cartessian coordinates. square.dif.MSF is the square diference between MSF of the proteins relative to the reference protein. We ranked profiles because we found it is the best way to deal with large differences in MSF of divergent sites. We also tried z-normalizing but the results were not good.

```{r mean-se-r.SDF-vs-site, fig.cap = "Black lines are the active sites and grey lines are their contacts"}

# comparison of r.SDF profiles with functional sites
## prepare dat
dat = siteComparison.all.datasets
dat$dataset = revalue(dat$dataset, c("medium" = "selection"))
dat$dataset = revalue(dat$dataset, c("mut" = "no-selection"))

## dat with means and standard errors
d = ddply(dat,c("dataset", "site", "AA", "shell"), function(x) {
                mean.r.SDF = mean(x$r.SDF, na.rm = T)
                n.data = sum(!is.na(x$r.SDF))
                se.r.SDF = sd(x$r.SDF, na.rm = T) / sqrt(n.data)
                data.frame(mean.r.SDF, n.data, se.r.SDF)
})

## find the active site and its contacts
active.sites = d$site[d$shell == 0]
contacts.active.sites = d$site[d$shell == 1]

## prepare plots with mean profiles and deviations
p = ggplot(d, aes(x = site, y = mean.r.SDF, col = dataset, fill = dataset)) +
    geom_line() +
    geom_ribbon(aes(ymin = mean.r.SDF - f95 * se.r.SDF, ymax = mean.r.SDF + se.r.SDF), alpha = .4, show.legend = F) +
    geom_vline(xintercept = active.sites, show.legend = F) +
    geom_vline(xintercept = contacts.active.sites, col = "grey", show.legend = F) +
    labs(x = "site", y = "<ranked square dif MSFi>") +
    scale_colour_manual(name = NULL, values = myColors) + 
    scale_fill_manual(name = NULL, values = myColors)

## plot separate and comparative plots
p.facet = p + facet_grid(dataset~., switch = "y") + theme(legend.position = "bottom")

p.facet %+% subset(d, dataset == "exp") 
p.facet %+% subset(d, dataset == "no-selection")
p.facet %+% subset(d, dataset == "selection") 
p.facet

## plot superimposed plots
p + theme(legend.position = "bottom")
```

```{r comparison-of-means}

# extract means
d.exp = subset(d, dataset == "exp")
d.mut = subset(d, dataset == "no-selection")
d.medium = subset(d, dataset == "selection")

mean.r.square.dif.MSF.exp = d.exp$mean.r.SDF
mean.r.square.dif.MSF.mut = d.mut$mean.r.SDF
mean.r.square.dif.MSF.medium = d.medium$mean.r.SDF

# calculate correlations
r.exp.mut = cor(mean.r.square.dif.MSF.exp, mean.r.square.dif.MSF.mut)
r.exp.medium = cor(mean.r.square.dif.MSF.exp, mean.r.square.dif.MSF.medium)
r.mut.medium = cor(mean.r.square.dif.MSF.mut, mean.r.square.dif.MSF.medium)

cor.df = data.frame("comparison" = c("exp vs no-selection", "exp vs selection", "no-selection vs selection"),
                    "R" = c(r.exp.mut, r.exp.medium, r.mut.medium))

knitr::kable(cor.df, digits = 2)

# plot comparative profiles 
par(pty = "s")

plot(x = mean.r.square.dif.MSF.exp, 
     y = mean.r.square.dif.MSF.mut, 
     xlab = "<r.square.dif.MSF> experimental", 
     ylab = "<r.square.dif.MSF> no-selection")
abline(0, 1)

plot(x = mean.r.square.dif.MSF.exp, 
     y = mean.r.square.dif.MSF.medium, 
     xlab = "<r.square.dif.MSF> experimental", 
     ylab = "<r.square.dif.MSF> selection")
abline(0, 1)

plot(x = mean.r.square.dif.MSF.mut, 
     y = mean.r.square.dif.MSF.medium, 
     xlab = "<r.square.dif.MSF> no-selection", 
     ylab = "<r.square.dif.MSF> selection")
abline(0, 1)
```

```{r comparison-with-MSF.p.ref}

# rank MSF.p.ref
r.MSF.p.ref = rank(MSF.p.ref)

# calculate correlations
r.exp = cor(mean.r.square.dif.MSF.exp, r.MSF.p.ref)
r.mut = cor(mean.r.square.dif.MSF.mut, r.MSF.p.ref)
r.medium = cor(mean.r.square.dif.MSF.medium, r.MSF.p.ref)

cor.df = data.frame("comparison" = c("<r.square.dif.MSF> experimental vs r.MSF.p.ref", "<r.square.dif.MSF> no-selection vs r.MSF.p.ref", "<r.square.dif.MSF> selection vs r.MSF.p.ref"),
                    "R" = c(r.exp, r.mut, r.medium))

knitr::kable(cor.df, digits = 2)

# plot comparative profiles 
par(pty = "s")

plot(x = mean.r.square.dif.MSF.exp, 
     y = r.MSF.p.ref, 
     xlab = "<r.square.dif.MSF> experimental", 
     ylab = "r.MSF.p.ref")
abline(0, 1)

plot(x = mean.r.square.dif.MSF.mut, 
     y = r.MSF.p.ref, 
     xlab = "<r.square.dif.MSF> no-selection", 
     ylab = "r.MSF.p.ref")
abline(0, 1)

plot(x = mean.r.square.dif.MSF.medium, 
     y = r.MSF.p.ref, 
     xlab = "<r.square.dif.MSF> selection", 
     ylab = "r.MSF.p.ref")
abline(0, 1)
```
```{r mean-z.RSD-profiles}

# prepare dat
dat = siteComparison.all.datasets.dri2
dat$dataset = revalue(dat$dataset, c("medium" = "selection"))
dat$dataset = revalue(dat$dataset, c("mut" = "no-selection"))

# dat with means and standard errors
d = ddply(dat,c("dataset", "site", "AA", "shell"), function(x) {
                mean.z.RSD = mean(x$z.RSD, na.rm = T)
                n.data = sum(!is.na(x$z.RSD))
                se.z.RSD = sd(x$z.RSD, na.rm = T) / sqrt(n.data)
                data.frame(mean.z.RSD, n.data, se.z.RSD)
})

# extract means
d.exp = subset(d, dataset == "exp")
d.mut = subset(d, dataset == "no-selection")
d.medium = subset(d, dataset == "selection")

mean.r.dri2.exp = d.exp$mean.z.RSD
mean.r.dri2.mut = d.mut$mean.z.RSD
mean.r.dri2.medium = d.medium$mean.z.RSD
```

### Comparison structure - dynamics

In this section we compare dri2 profiles (structural variability) with square dif MSF profiles (dynamical variability). To do this, we ranked each profile. 

```{r structure-vs-dynamics}

# rank profiles
mean.r.dri2.exp = rank(mean.r.dri2.exp)
mean.r.dri2.mut = rank(mean.r.dri2.mut)
mean.r.dri2.medium = rank(mean.r.dri2.medium)

mean.r.square.dif.MSF.exp = rank(mean.r.square.dif.MSF.exp)
mean.r.square.dif.MSF.mut = rank(mean.r.square.dif.MSF.mut)
mean.r.square.dif.MSF.medium = rank(mean.r.square.dif.MSF.medium)

# plot comparative profiles
par(pty = "s")

plot(x = mean.r.square.dif.MSF.exp, 
     y = mean.r.dri2.exp, 
     xlab = "r<r.square.dif.MSF> experimental", 
     ylab = "r<dri2> experimental")
abline(0, 1)

plot(x = mean.r.square.dif.MSF.mut, 
     y = mean.r.dri2.mut, 
     xlab = "r<r.square.dif.MSF> no-selection", 
     ylab = "r<dri2> no-selection")
abline(0, 1)

plot(x = mean.r.square.dif.MSF.medium, 
     y = mean.r.dri2.medium, 
     xlab = "r<r.square.dif.MSF> selection", 
     ylab = "r<dri2> selection")
abline(0, 1)

# calculate correlations
r.exp = cor(mean.r.square.dif.MSF.exp, mean.r.dri2.exp)
r.medium = cor(mean.r.square.dif.MSF.medium, mean.r.dri2.medium)
r.mut = cor(mean.r.square.dif.MSF.mut, mean.r.dri2.mut)

cor.df = data.frame("comparison structure - dynamics" = c("exp", "selection", "no-selection"),
                    "R" = c(r.exp, r.medium, r.mut))
knitr::kable(cor.df, digits = 2)
```
