---
title: "Dynamical Divergence Analysis"
author: "Maria Laura Marcos, Julian Echave"
output: html_document
---

# Introduction
We study the evolutionary divergence of proteins using the LF-ENM and comparing simulated mutants with experimental data.

```{r setup, include = FALSE}
# set chunk options
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r load-packages}
# load packages
library(ggplot2)
library(reshape2)
library(plyr)
library(quantreg)
library(bio3d)

# load functions
source(file.path(data.dir, "multiplot.R"))
source(file.path(data.dir, "my-functions.R")) 
```

```{r set-filenames}
# set input filenames
## data
reference.fname = file.path(data.dir, paste(family, "_ref.txt", sep = ""))
protein_list.fname = file.path(data.dir, paste(family, "_list.txt", sep = ""))

## profiles to compare
### nH
nH.exp.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.exp.nH.csv", sep = ""))
nH.medium.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_medium.sel_K.analysis_Keff_out_m.theo.nH.csv", sep = ""))
nH.mut.fname = file.path(data.dir,paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.theo.nH.csv", sep = ""))
```

```{r set_reference_protein}
# which is the reference protein?
reference = as.character(read.table(reference.fname, header = F)[1, 1])
if (reference != p.ref) {
  print("Warning: different references")
}
```
We studied the `r family` family. 
We used the ENM `r enm` with R0 = `r R0` to generate mutants.
We used as reference for the ENM the protein with pdb code `r reference`. 
We simulated `r n.mut.p` mutants of this reference for each protein of the family.
The `r family` family is of the type `r type` and consists of the following proteins:

```{r set-experimental-protein-names, comment = ""}
# experimental protein names
protein.exp = read.table(protein_list.fname, header = F, stringsAsFactors = F)[, 1]
protein.exp = protein.exp[protein.exp != reference]
print(protein.exp)
```
```{r prepare-mode-data}
# prepare the data
nH.exp = read.csv(nH.exp.fname, header = T)
nH.mut = read.csv(nH.mut.fname, header = T)
nH.medium = read.csv(nH.medium.fname, header = T)
```
### Dynamical divergence along normal modes

In this section we consider dynamical divergence using normal modes coordinates. We calculated <nH> and we z-normalized profiles.

```{r comparison-of-means, fig.cap = "blue = experimental - green = no-selection - red = selection"}
# calculate means
mean.nH.exp = colMeans(nH.exp, na.rm = T)
mean.nH.mut = colMeans(nH.mut)
mean.nH.medium = colMeans(nH.medium)

# scale profiles
mean.nH.exp = vscale(mean.nH.exp[which(!is.na(mean.nH.exp))])
mean.nH.mut = vscale(mean.nH.mut[which(!is.na(mean.nH.mut))])
mean.nH.medium = vscale(mean.nH.medium[which(!is.na(mean.nH.medium))])

plot(mean.nH.exp, ylab = "<z.nH>", xlab = "mode", col = "blue")
points(mean.nH.mut, col = "green")
points(mean.nH.medium, col = "red")

r.exp.mut = cor(mean.nH.exp, mean.nH.mut)
r.exp.medium = cor(mean.nH.exp, mean.nH.medium)
r.mut.medium = cor(mean.nH.mut, mean.nH.medium)

cor.df = data.frame("comparison" = c("exp vs no-selection", "exp vs selection", "no-selection vs selection"),
                    "R" = c(r.exp.mut, r.exp.medium, r.mut.medium))
knitr::kable(cor.df, digits = 2)
```

```{r vs-mean-plots}

# plot comparative profiles 
par(pty = "s")

plot(x = mean.nH.exp, 
     y = mean.nH.mut, 
     xlab = "<z.nH> experimental", 
     ylab = "<z.nH> no-selection")
abline(0, 1)

plot(x = mean.nH.exp, 
     y = mean.nH.medium, 
     xlab = "<z.nH> experimental", 
     ylab = "<z.nH> selection")
abline(0, 1)

plot(x = mean.nH.mut, 
     y = mean.nH.medium, 
     xlab = "<z.nH> no-selection", 
     ylab = "<z.nH> selection")
abline(0, 1)
```

```{r comparison-of-means-100-modes}

# get first 100 modes and re-scale
mean.nH.exp = vscale(mean.nH.exp[1:100])
mean.nH.mut = vscale(mean.nH.mut[1:100])
mean.nH.medium = vscale(mean.nH.medium[1:100])

plot(mean.nH.exp, ylab = "<z.nH>", xlab = "mode", col = "blue")
points(mean.nH.mut, col = "green")
points(mean.nH.medium, col = "red")

r.exp.mut = cor(mean.nH.exp, mean.nH.mut)
r.exp.medium = cor(mean.nH.exp, mean.nH.medium)
r.mut.medium = cor(mean.nH.mut, mean.nH.medium)

cor.df = data.frame("comparison" = c("exp vs no-selection", "exp vs selection", "no-selection vs selection"),
                    "R" = c(r.exp.mut, r.exp.medium, r.mut.medium))
knitr::kable(cor.df, digits = 2)
```

```{r vs-mean-plots-100-modes}

# plot comparative profiles 
plot(x = mean.nH.exp, 
     y = mean.nH.mut, 
     xlab = "<z.nH> experimental", 
     ylab = "<z.nH> no-selection")
abline(0, 1)

plot(x = mean.nH.exp, 
     y = mean.nH.medium, 
     xlab = "<z.nH> experimental", 
     ylab = "<z.nH> selection")
abline(0, 1)

plot(x = mean.nH.mut, 
     y = mean.nH.medium, 
     xlab = "<z.nH> no-selection", 
     ylab = "<z.nH> selection")
abline(0, 1)
```
```{r comparison-of-means-20-modes}

# get first 100 modes and re-scale
mean.nH.exp = vscale(mean.nH.exp[1:20])
mean.nH.mut = vscale(mean.nH.mut[1:20])
mean.nH.medium = vscale(mean.nH.medium[1:20])

plot(mean.nH.exp, ylab = "<z.nH>", xlab = "mode", col = "blue")
points(mean.nH.mut, col = "green")
points(mean.nH.medium, col = "red")

r.exp.mut = cor(mean.nH.exp, mean.nH.mut)
r.exp.medium = cor(mean.nH.exp, mean.nH.medium)
r.mut.medium = cor(mean.nH.mut, mean.nH.medium)

cor.df = data.frame("comparison" = c("exp vs no-selection", "exp vs selection", "no-selection vs selection"),
                    "R" = c(r.exp.mut, r.exp.medium, r.mut.medium))
knitr::kable(cor.df, digits = 2)
```

```{r vs-mean-plots-20-modes}

# plot comparative profiles 
plot(x = mean.nH.exp, 
     y = mean.nH.mut, 
     xlab = "<z.nH> experimental", 
     ylab = "<z.nH> no-selection")
abline(0, 1)

plot(x = mean.nH.exp, 
     y = mean.nH.medium, 
     xlab = "<z.nH> experimental", 
     ylab = "<z.nH> selection")
abline(0, 1)

plot(x = mean.nH.mut, 
     y = mean.nH.medium, 
     xlab = "<z.nH> no-selection", 
     ylab = "<z.nH> selection")
abline(0, 1)
```