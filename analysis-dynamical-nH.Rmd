---
title: "Dynamical Divergence Analysis"
author: "Maria Laura Marcos, Julian Echave"
output: html_document
---

# Introduction
We study the evolutionary divergence of proteins using the LF-ENM and comparing simulated mutants with experimental data.

```{r setup, include = FALSE}
# set chunk options
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r load-packages}
# load packages
library(ggplot2)
library(reshape2)
library(plyr)
library(quantreg)
library(bio3d)

# load functions
source(file.path(data.dir, "multiplot.R"))
source(file.path(data.dir, "my-functions.R")) 
```

```{r set-filenames}
# set input filenames
## data
reference.fname = file.path(data.dir, paste(family, "_ref.txt", sep = ""))
protein_list.fname = file.path(data.dir, paste(family, "_list.txt", sep = ""))

## profiles to compare
### nH
nH.exp.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.exp.nH.csv", sep = ""))
nH.medium.fname = file.path(data.dir, paste(family, "_R0_", R0, "_beta_medium.sel_K.analysis_Keff_out_m.theo.nH.csv", sep = ""))
nH.mut.fname = file.path(data.dir,paste(family, "_R0_", R0, "_beta_no.sel_K.analysis_Keff_out_m.theo.nH.csv", sep = ""))
```

```{r set_reference_protein}
# which is the reference protein?
reference = as.character(read.table(reference.fname, header = F)[1, 1])
if (reference != p.ref) {
  print("Warning: different references")
}
```
We studied the `r family` family. 
We used the ENM `r enm` with R0 = `r R0` to generate mutants.
We used as reference for the ENM the protein with pdb code `r reference`. 
We simulated `r n.mut.p` mutants of this reference for each protein of the family.
The `r family` family is of the type `r type` and consists of the following proteins:

```{r set-experimental-protein-names, comment = ""}
# experimental protein names
protein.exp = read.table(protein_list.fname, header = F, stringsAsFactors = F)[, 1]
protein.exp = protein.exp[protein.exp != reference]
print(protein.exp)
```
```{r prepare-mode-data}

# prepare the data
nH.exp = read.csv(nH.exp.fname, header = T)
rownames(nH.exp) = paste("mut", rownames(nH.exp), sep = "")
nH.mut = read.csv(nH.mut.fname, header = T)
rownames(nH.mut) = paste("mut", rownames(nH.mut), sep = "")
nH.medium = read.csv(nH.medium.fname, header = T)
rownames(nH.medium) = paste("mut", rownames(nH.medium), sep = "")
    
mode = seq(ncol(nH.medium))
    
# Prepare modeComparison
tnH.medium = as.data.frame(t(as.matrix(nH.medium)))
tnH.medium = cbind(data.frame("mode" = mode), tnH.medium)
modeComparison.medium = melt(tnH.medium, "mode", variable.name = "protein", value.name = "nH")
modeComparison.medium = ddply(modeComparison.medium, "protein", mutate, "nH" = nH / mean(nH, na.rm = T))
    
tnH.mut = as.data.frame(t(as.matrix(nH.mut)))
tnH.mut = cbind(data.frame("mode" = mode), tnH.mut)
modeComparison.mut = melt(tnH.mut, "mode", variable.name = "protein", value.name = "nH")
modeComparison.mut = ddply(modeComparison.mut, "protein", mutate, "nH" = nH / mean(nH, na.rm = T))
    
tnH.exp = as.data.frame(t(as.matrix(nH.exp)))
tnH.exp = cbind(data.frame("mode" = mode), tnH.exp)
modeComparison.exp = melt(tnH.exp, "mode", variable.name = "protein", value.name = "nH")
modeComparison.exp = ddply(modeComparison.exp, "protein", mutate, "nH" = nH / mean(nH, na.rm = T))
    
# modeComparison.exp has NA's because for proteins with gaps when using Keff there're less modes
#print("Warning: modeComparison.exp <- na.omit(modeComparison.exp)")
modeComparison.exp <- na.omit(modeComparison.exp)
modeComparison.medium <- na.omit(modeComparison.medium)
modeComparison.mut <- na.omit(modeComparison.mut)
    
modeComparison.all.datasets = rbind(data.frame("dataset" = "exp", modeComparison.exp),                                                   data.frame("dataset" = "mut", modeComparison.mut),
                                    data.frame("dataset" = "medium", modeComparison.medium))
    
dat = modeComparison.all.datasets
dat$dataset = revalue(dat$dataset, c("medium" = "selection"))
dat$dataset = revalue(dat$dataset, c("mut" = "no-selection"))
    
# calculate dataset of means
d = ddply(dat,c("dataset", "mode"), function(x) {
    mean.nH = mean(x$nH)
    data.frame(mean.nH)
    })
    
    # calculate correlations berween profiles
    d.exp = subset(d, dataset == "exp")
    d.mut = subset(d, dataset == "no-selection")
    d.medium = subset(d, dataset == "selection")
```
### Dynamical divergence along normal modes

In this section we consider dynamical divergence using normal modes coordinates. We calculated <nH> and we normalized profiles.

```{r means}
# get means
mean.nH.exp =  subset(d, dataset == "exp")$mean.nH
mean.nH.mut = d.mut = subset(d, dataset == "no-selection")$mean.nH
mean.nH.medium = subset(d, dataset == "selection")$mean.nH
```

```{r comparison-of-means-100-modes}
# get first 100 modes and re-scale
mean.nH.exp = mean.nH.exp[1:100]
mean.nH.mut = mean.nH.mut[1:100]
mean.nH.medium = mean.nH.medium[1:100]

plot(mean.nH.exp, ylab = "<nH>", xlab = "mode", col = "blue")
points(mean.nH.mut, col = "green")
points(mean.nH.medium, col = "red")

r.exp.mut = cor(mean.nH.exp, mean.nH.mut)
r.exp.medium = cor(mean.nH.exp, mean.nH.medium)
r.mut.medium = cor(mean.nH.mut, mean.nH.medium)

cor.df = data.frame("comparison" = c("exp vs no-selection", "exp vs selection", "no-selection vs selection"),
                    "R" = c(r.exp.mut, r.exp.medium, r.mut.medium))
knitr::kable(cor.df, digits = 2)
```

```{r vs-mean-plots-100-modes}

# plot comparative profiles 
plot(x = mean.nH.exp, 
     y = mean.nH.mut, 
     xlab = "<nH> experimental", 
     ylab = "<nH> no-selection")
abline(0, 1)

plot(x = mean.nH.exp, 
     y = mean.nH.medium, 
     xlab = "<nH> experimental", 
     ylab = "<nH> selection")
abline(0, 1)

plot(x = mean.nH.mut, 
     y = mean.nH.medium, 
     xlab = "<nH> no-selection", 
     ylab = "<nH> selection")
abline(0, 1)
```
