---
title: "Estudio variabilidad estructural proteica"
output: html_document
---
```{r setup, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, echo = FALSE, message = FALSE)
```

```{r}

# Source functions.
source("FUNCTIONS/CalculateGroupsMeansQuantiles.R")

# Set directories.
data.dir <- "DATA"
out.dir <- "OUT"

### Experimental ###
analysis.fname.id <- paste(family, "_R0_", R0, "_beta_", beta, "_K.analysis_", K.analysis, sep = "")

m.exp.Pn = read.csv(file.path(out.dir, paste(analysis.fname.id, "_out_m.exp.Pn.csv", sep = "")))[, 1:100]
mean.exp.Pn = colMeans(m.exp.Pn)

n.prot = nrow(m.exp.Pn)

exp.Pn.quantile1 = matrix(ncol = ncol(m.exp.Pn), nrow = 1)
exp.Pn.quantile2 = matrix(ncol = ncol(m.exp.Pn), nrow = 1)

for (i in (1:ncol(m.exp.Pn))) {
    exp.Pn.quantiles = as.vector(quantile((m.exp.Pn[, i]), probs = c(0.05, 0.95)))
    exp.Pn.quantile1[1, i] = exp.Pn.quantiles[1]
    exp.Pn.quantile2[1, i] = exp.Pn.quantiles[2]
}

m.exp.smooth.norm.dr.squarei = read.csv(file.path(out.dir, paste(analysis.fname.id, "_out_m.exp.smooth.norm.dr.squarei.csv", sep = "")))
exp.smooth.norm.MSDi = colMeans(m.exp.smooth.norm.dr.squarei, na.rm = T )

### Theoretical ###

m.theo.Pn = read.csv(file.path(out.dir, paste(analysis.fname.id, "_out_m.theo.Pn.csv", sep = "")))[, 1:100]

m.theo.smooth.norm.dr.squarei = read.csv(file.path(out.dir, paste(analysis.fname.id, "_out_m.theo.smooth.norm.dr.squarei.csv", sep = "")))
theo.smooth.norm.MSDi = colMeans(m.theo.smooth.norm.dr.squarei, na.rm = T )

n.mut = nrow(m.theo.Pn)

```

### MSDi

Los perfiles teoricos de  smooth.norm.MSDi fueron fiteados con los perfiles exterimentales. Se compararon y se calcularon R^2 y MSE. 

```{r}

fit = lm(exp.smooth.norm.MSDi ~ theo.smooth.norm.MSDi )
MSDi.fit = fitted.values(fit)
R2 = cor(exp.smooth.norm.MSDi[!is.na(exp.smooth.norm.MSDi)], MSDi.fit) ^ 2 
MSE = mean((MSDi.fit - exp.smooth.norm.MSDi[!is.na(exp.smooth.norm.MSDi)]) ^ 2)

```

```{r}
plot(as.numeric(MSDi.fit), xlab = "site", ylab = "Experimental", ylim = c(0,3))
points(exp.smooth.norm.MSDi[!is.na(exp.smooth.norm.MSDi)], col = "red")
legend("topleft", paste("R^2", round(R2, digits = 2), " ", "MSE", signif(MSE, digits = 4)), bty = "n", text.col = "red")
```

*negro:* Promedio teorico.

*rojo:* Promedio experimental.


### Pn y Qn
Las distribuciones de *Pn* y *Qn* de los conjuntos son las siguientes:
  
```{r}
# Re-ordenate Pn.
m.theo.index = matrix(ncol = 1, nrow = n.mut)
for (P in (1:n.prot)) {
  for (mut in (1:n.mut.p)) {
    m.theo.index[(P - 1) * n.mut.p + mut, ] = ((mut - 1) * 10 + P)
  }
}
m.theo.Pn = m.theo.Pn[as.vector(m.theo.index), ]

# Calculate groups, means and quantiles.
theo.Pn.group = CalculateGroupsMeansQuantiles(m.theo.Pn, n.mut.p, n.prot)
mean.theo.Pn.group = theo.Pn.group$mean.mean.group
theo.Pn.group.quantile1 = theo.Pn.group$mean.quantile1.group
theo.Pn.group.quantile2 = theo.Pn.group$mean.quantile2.group
theo.Pn.quantile1.mean = theo.Pn.group$quantile1.mean
theo.Pn.quantile2.mean = theo.Pn.group$quantile2.mean
```


```{r}

# Graphics.

plot(mean.theo.Pn.group, 
     main = "Pn promedio", 
     xlab = "nmodo",
     ylab = "Pn",
     ylim = c(0, max(c(theo.Pn.group.quantile2, mean.exp.Pn))))
lines(theo.Pn.group.quantile1)
lines(theo.Pn.group.quantile2)
points(mean.exp.Pn, col = "red")
lines(as.vector(exp.Pn.quantile1), col = "red")
lines(as.vector(exp.Pn.quantile2), col = "red")

```

*Negro*: Puntos: promedio de promedios teorico. Lineas: promedio de cuantiles 0.05 y 0.95 de `r n.mut.p` grupos de `r n.prot` mutantes teoricas.

*Rojo*: Puntos: promedio experimental. Lineas: cuantiles 0.05 y 0.95 experimentales.

```{r}

# Graphics.

plot(mean.theo.Pn.group, 
     main = "Pn promedio", 
     xlab = "nmodo",
     ylab = "Pn",
     ylim = c(0, max(c(theo.Pn.group.quantile2, mean.exp.Pn))))
lines(as.vector(theo.Pn.quantile1.mean))
lines(as.vector(theo.Pn.quantile2.mean))
points(mean.exp.Pn, col = "red")

```

*Negro*: Puntos: promedio de promedios teorico. Lineas:  cuantiles 0.05 y 0.95 de promedios de `r n.mut.p` grupos de `r n.prot` mutantes teoricas.

*Rojo*: Promedio experimental.

```{r}
layout(matrix(1:2, 1, 2, byrow = T)) 

fit = lm(mean.exp.Pn ~ mean.theo.Pn.group)
Pn.fit = fitted.values(fit)
R2 = cor(mean.exp.Pn, Pn.fit) ^ 2 
MSE = mean((Pn.fit - mean.exp.Pn) ^ 2)
plot(Pn.fit, mean.exp.Pn, xlab = "Pn promedio de promedios teorico", ylab = "Pn promedio experimental", main = "Pn")
abline(0, 1)
legend("topleft", paste("R^2", round(R2, digits = 2)), bty = "n", text.col = "red")
legend("bottomright", paste("MSE", signif(MSE, digits = 2)), bty = "n", text.col = "red")


```

