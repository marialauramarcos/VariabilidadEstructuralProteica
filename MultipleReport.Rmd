---
title: "Estudio variabilidad estructural proteica"
output: html_document
---
```{r setup, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, echo = FALSE, message = FALSE)
```

```{r}

# Source functions.
source("FUNCTIONS/CalculateGroupsMeansQuantiles.R")

# Read files and calculate measures.
data.dir <- "DATA"
out.dir <- "OUT"

# Family.
pdbid <- read.csv(file.path(data.dir, paste(family, "_dataset.csv", sep = "")))$pdbid
n.exp = length(pdbid)
n.sites.p.1 = read.csv(file.path(out.dir, paste(family, "_out_m.n.sites.p.ref.csv", sep = "")))$V1[1]
m.n.sites.p.2 = read.csv(file.path(out.dir, paste(family, "_out_m.n.sites.p.2.csv", sep = "")))$V1
m.n.aligned = read.csv(file.path(out.dir, paste(family, "_out_m.n.aligned.csv", sep = "")))$V1
identity = read.csv(file.path(out.dir, paste(family, "_out_m.identity.csv", sep = "")))$V1

# Read experimental.
analysis.fname.id <- paste(family, "_R0_", R0, "_K.analysis_", K.analysis, sep = "")

m.exp.Pn = read.csv(file.path(out.dir, paste(analysis.fname.id, "_out_m.exp.Pn.csv", sep = "")))[, 1:100]
mean.exp.Pn = colMeans(m.exp.Pn)

exp.Pn.quantile1 = matrix(0, ncol = ncol(m.exp.Pn), nrow = 1)
exp.Pn.quantile2 = matrix(0, ncol = ncol(m.exp.Pn), nrow = 1)

for (i in (1:ncol(m.exp.Pn))){
    exp.Pn.quantiles = as.vector(quantile((m.exp.Pn[, i]), probs = c(0.05, 0.95)))
    exp.Pn.quantile1[1, i] = exp.Pn.quantiles[1]
    exp.Pn.quantile2[1, i] = exp.Pn.quantiles[2]
}

m.exp.smooth.norm.dr.squarei = read.csv(file.path(out.dir, paste(analysis.fname.id, "_out_m.exp.smooth.norm.dr.squarei.csv", sep = "")))
exp.smooth.norm.MSDi = colMeans(m.exp.smooth.norm.dr.squarei, na.rm = T )

### Theoretical ###
  mut.fname.id <- paste(family, "_R0_", R0, sep = "")

m.theo.Pn = read.csv(file.path(out.dir, paste(analysis.fname.id, "_out_m.theo.Pn.csv", sep = "")))[, 1:100]
m.theo.smooth.norm.dr.squarei = read.csv(file.path(out.dir, paste(analysis.fname.id, "_out_m.theo.smooth.norm.dr.squarei.csv", sep = "")))
prob.accept.mut.all.betas = read.csv(file.path(out.dir, paste(mut.fname.id, "_out_prob.accept.mut.all.betas.csv", sep = "")))

n.mut = nrow(m.theo.Pn)

prob.accept.mut.beta.0.1 = prob.accept.mut.all.betas[1, ]
prob.accept.mut.beta.0.5 = prob.accept.mut.all.betas[2, ]
prob.accept.mut.beta.0.9 = prob.accept.mut.all.betas[3, ]

mean.beta.0.theo.Pn = ColMeans(m.theo.Pn)
mean.beta.0.1.theo.Pn = colSums((m.theo.Pn) * as.numeric(prob.accept.mut.beta.0.1))/ sum(prob.accept.mut.beta.0.1)
mean.beta.0.5.theo.Pn = colSums(m.theo.Pn * as.numeric(prob.accept.mut.beta.0.5))/ sum(prob.accept.mut.beta.0.5)
mean.beta.0.9.theo.Pn = colSums(m.theo.Pn * as.numeric(prob.accept.mut.beta.0.9))/ sum(prob.accept.mut.beta.0.9)

mean.beta.0.theo.smooth.MSDi = colMeans(m.theo.smooth.dr.squarei, na.rm = T)
mean.beta.0.1.theo.smooth.MSDi = colSums(m.theo.smooth.dr.squarei * as.numeric(prob.accept.mut.beta.0.1), na.rm = T)/ sum(prob.accept.mut.beta.0.1, na.rm = T )
mean.beta.0.5.theo.smooth.MSDi = colSums(m.theo.smooth.dr.squarei * as.numeric(prob.accept.mut.beta.0.5), na.rm = T)/ sum(prob.accept.mut.beta.0.5, na.rm = T)
mean.beta.0.9.theo.smooth.MSDi = colSums(m.theo.smooth.dr.squarei * as.numeric(prob.accept.mut.beta.0.9), na.rm = T)/ sum(prob.accept.mut.beta.0.9, na.rm = T)
```

Los perfiles teoricos de  smooth.norm.MSDi fueron fiteados con los perfiles exterimentales. Se compararon y se calcularon R^2 y MSE. 
```{r}
keep.data = c()
```

```{r}
layout(matrix(1:4, 2, 2, byrow = F)) 

fit.beta.0 = lm(exp.smooth.norm.MSDi ~ mean.beta.0.theo.smooth.MSDi )
MSDi.fit.beta.0 = fitted.values(fit.beta.0)
R2.beta.0 = cor(exp.smooth.norm.MSDi[!is.na(exp.smooth.norm.MSDi)], MSDi.fit.beta.0) ^ 2 
MSE.beta.0 = mean((MSDi.fit.beta.0 - exp.smooth.norm.MSDi[!is.na(exp.smooth.norm.MSDi)]) ^ 2)

fit.beta.0.1 = lm(exp.smooth.norm.MSDi ~ mean.beta.0.1.theo.smooth.MSDi )
MSDi.fit.beta.0.1 = fitted.values(fit.beta.0.1)
R2.beta.0.1 = cor(exp.smooth.norm.MSDi[!is.na(exp.smooth.norm.MSDi)], MSDi.fit.beta.0.1) ^ 2 
MSE.beta.0.1 = mean((MSDi.fit.beta.0.1 - exp.smooth.norm.MSDi[!is.na(exp.smooth.norm.MSDi)]) ^ 2)

fit.beta.0.5 = lm(exp.smooth.norm.MSDi ~ mean.beta.0.5.theo.smooth.MSDi )
MSDi.fit.beta.0.5 = fitted.values(fit.beta.0.5)
R2.beta.0.5 = cor(exp.smooth.norm.MSDi[!is.na(exp.smooth.norm.MSDi)], MSDi.fit.beta.0.5) ^ 2 
MSE.beta.0.5 = mean((MSDi.fit.beta.0.5 - exp.smooth.norm.MSDi[!is.na(exp.smooth.norm.MSDi)]) ^ 2)

fit.beta.0.9 = lm(exp.smooth.norm.MSDi ~ mean.beta.0.9.theo.smooth.MSDi )
MSDi.fit.beta.0.9 = fitted.values(fit.beta.0.9)
R2.beta.0.9 = cor(exp.smooth.norm.MSDi[!is.na(exp.smooth.norm.MSDi)], MSDi.fit.beta.0.9) ^ 2 
MSE.beta.0.9 = mean((MSDi.fit.beta.0.9 - exp.smooth.norm.MSDi[!is.na(exp.smooth.norm.MSDi)]) ^ 2)


```

```{r}
lines(as.numeric(MSDi.fit.beta.0), type = "l", xlab = "site", ylab = "Theoretical MSDi BETA = 0", col = "red")

lines(MSDi.fit.beta.0.1, type = "l", xlab = "site", ylab = "Theoretical MSDi BETA = 0.1", col = "red")

lines(MSDi.fit.beta.0.5, type = "l", xlab = "site", ylab = "Theoretical MSDi BETA = 0.5", col = "blue")

lines(MSDi.fit.beta.0.9, type = "l", xlab = "site", ylab = "Theoretical MSDi BETA = 0.9", col = "green")

```

```{r}
plot(exp.smooth.norm.MSDi[!is.na(exp.smooth.norm.MSDi)], type = "l", xlab = "site", ylab = "Experimental")

```

```{r}
plot(nsF.theo.MSDi.s, type = "l", xlab = "site", ylab = "Merge", ylim = c(0, 0.14))
points(exp.MSDi.s, col = "red", type = "l")
legend("topleft", paste("R^2", round(R2.nsF.cF.s, digits = 2), " ", "MSE", signif(MSE.nsF.cF.s, digits = 4)), bty = "n", text.col = "red")
rojo: experimental
negro: teorico


## Pn y Qn
Las distribuciones de *Pn* y *Qn* de los conjuntos son las siguientes:
  
```{r}

# Calculate groups, means and quantiles.
theo.Pn.group = CalculateGroupsMeansQuantiles(theo.Pn, n.mut.p, n.exp)
mean.theo.Pn.group = theo.Pn.group$mean.mean.group
theo.Pn.group.quantile1 = theo.Pn.group$mean.quantile1.group
theo.Pn.group.quantile2 = theo.Pn.group$mean.quantile2.group

```


```{r}

# Graphics.

layout(matrix(1:2, 1, 2, byrow = T)) 

plot(mean.nsF.cF.theo.Pn.group, 
     main = "Pn promedio ns = F", 
     xlab = "nmodo",
     ylab = "Pn",
     ylim = c(0, max(c(nsF.cF.theo.Pn.group.quantile2, mean.cF.exp.Pn))))
lines(nsF.cF.theo.Pn.group.quantile1)
lines(nsF.cF.theo.Pn.group.quantile2)
points(mean.cF.exp.Pn, col = "red")
lines(as.vector(cF.exp.Pn.quantile1), col = "red")
lines(as.vector(cF.exp.Pn.quantile2), col = "red")

plot(mean.nsT.cF.theo.Pn.group, 
     main = "Pn promedio ns = T", 
     xlab = "nmodo",
     ylab = "Pn",
     ylim = c(0, max(c(nsT.cF.theo.Pn.group.quantile2, mean.cF.exp.Pn))))
lines(nsT.cF.theo.Pn.group.quantile1)
lines(nsT.cF.theo.Pn.group.quantile2)
points(mean.cF.exp.Pn, col = "red")
lines(as.vector(cF.exp.Pn.quantile1), col = "red")
lines(as.vector(cF.exp.Pn.quantile2), col = "red")

```

*Negro*: Puntos: promedio de promedios teorico. Lineas: promedio de cuantiles 0.05 y 0.95 de `r n.mut.p` grupos de `r n.exp` mutantes teoricas.
*Rojo*: Experimental. Puntos: promedio. Lineas: cuantiles 0.05 y 0.95.

Posteriormente, los perfiles de Pn teoricos fueron fiteados con los perfiles exterimentales. Se compararon y se calcularon R^2 y MSE. 

```{r}
layout(matrix(1:2, 1, 2, byrow = T)) 

fit.nsF.cF = lm(mean.cF.exp.Pn ~ mean.nsF.cF.theo.Pn.group)
Pn.fit.nsF.cF = fitted.values(fit.nsF.cF)
R2.nsF.cF = cor(mean.cF.exp.Pn, Pn.fit.nsF.cF) ^ 2 
MSE.nsF.cF = mean((Pn.fit.nsF.cF - mean.cF.exp.Pn) ^ 2)
plot(Pn.fit.nsF.cF, mean.cF.exp.Pn, xlab = "Pn teorico", ylab = "Pn experimental", main = "ns = F c = F")
abline(0, 1)
legend("topleft", paste("R^2", round(R2.nsF.cF, digits = 2)), bty = "n", text.col = "red")
legend("bottomright", paste("MSE", signif(MSE.nsF.cF, digits = 2)), bty = "n", text.col = "red")

keep.data = c(keep.data, R2.nsF.cF, MSE.nsF.cF)

fit.nsT.cF = lm(mean.cF.exp.Pn ~ mean.nsT.cF.theo.Pn.group)
Pn.fit.nsT.cF = fitted.values(fit.nsT.cF)
R2.nsT.cF = cor(mean.cF.exp.Pn, Pn.fit.nsT.cF) ^ 2 
MSE.nsT.cF = mean((Pn.fit.nsT.cF - mean.cF.exp.Pn) ^ 2)
plot(Pn.fit.nsT.cF, mean.cF.exp.Pn, xlab = "Pn teorico", ylab = "Pn experimental", main = "ns = T c = F")
abline(0, 1)
legend("topleft", paste("R^2", round(R2.nsT.cF, digits = 2)), bty = "n", text.col = "red")
legend("bottomright", paste("MSE", signif(MSE.nsT.cF, digits = 2)), bty = "n", text.col = "red")

keep.data = c(keep.data, R2.nsT.cF, MSE.nsT.cF)

```

